<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Management Interface</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* === CSS RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* === COLOR THEME === */
        :root {
            --primary-color: #003135;
            --primary-light: #00474A;
            --primary-dark: #001F22;
            --primary-white: #FFFFFF;
            --secondary-light: #F0F5F5;
            --text-dark: #212529;
            --text-gray: #5A6C6D;
            --border-color: #D1DDDE;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --info-color: #17A2B8;
            --shadow: 0 2px 10px rgba(0, 49, 53, 0.08);
            --shadow-hover: 0 5px 20px rgba(0, 49, 53, 0.12);
            --accent-color: #00A3A8;
        }
        
        body {
            background: var(--secondary-light);
            color: var(--text-dark);
            overflow-x: hidden;
        }
        
        /* === LOGIN PAGE WITH ANIMATION === */
        .login-container { 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 50%, var(--accent-color) 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: float 20s linear infinite;
            opacity: 0.3;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-50px, -50px) rotate(360deg); }
        }
        
        .login-box { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; padding: 50px; 
            width: 90%; max-width: 450px; 
            box-shadow: var(--shadow-hover);
            text-align: center;
            position: relative;
            z-index: 2;
            animation: slideUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid rgba(0, 49, 53, 0.1);
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .login-box h2 { 
            margin-bottom: 30px; color: var(--primary-color); 
            font-size: 32px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            animation: fadeIn 1s ease-out 0.3s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-box p { 
            color: var(--text-gray); margin-bottom: 35px; 
            font-size: 16px; line-height: 1.6;
            animation: fadeIn 1s ease-out 0.5s both;
        }
        
        .input-group { 
            margin-bottom: 25px; text-align: left; 
            animation: fadeIn 1s ease-out 0.7s both;
        }
        
        .input-group label { 
            display: block; margin-bottom: 10px; font-weight: 600; 
            color: var(--primary-color); 
            display: flex; align-items: center; gap: 10px;
        }
        
        .input-group input { 
            width: 100%; padding: 16px; 
            border: 2px solid var(--border-color); 
            border-radius: 10px; font-size: 16px; 
            background: var(--primary-white);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }
        
        .input-group input:focus { 
            border-color: var(--primary-color); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(0, 49, 53, 0.1);
            transform: translateY(-2px);
        }
        
        .login-btn { 
            width: 100%; padding: 16px; 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); 
            color: var(--primary-white); 
            border: none; border-radius: 10px; font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; transition: all 0.3s; margin-top: 10px;
            position: relative; overflow: hidden;
            animation: fadeIn 1s ease-out 0.9s both;
        }
        
        .login-btn:hover { 
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%); 
            transform: translateY(-3px); 
            box-shadow: 0 10px 25px rgba(0, 49, 53, 0.2);
        }
        
        .login-btn:active {
            transform: translateY(-1px);
        }
        
        .login-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
        }
        
        .login-btn:hover::after {
            animation: shine 1s ease-out;
        }
        
        @keyframes shine {
            100% { transform: translateX(100%); }
        }
        
        .error-message { 
            color: var(--danger-color); text-align: center; margin-top: 20px; 
            padding: 12px; background: rgba(220, 53, 69, 0.1); 
            border-radius: 8px; display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .login-animation {
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: floatBall 15s linear infinite;
            z-index: 1;
        }
        
        .login-animation:nth-child(2) {
            width: 150px;
            height: 150px;
            animation-delay: -5s;
            top: 20%;
            left: 10%;
        }
        
        .login-animation:nth-child(3) {
            width: 80px;
            height: 80px;
            animation-delay: -10s;
            bottom: 30%;
            right: 15%;
        }
        
        @keyframes floatBall {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(100px, -50px) rotate(90deg); }
            50% { transform: translate(0, -100px) rotate(180deg); }
            75% { transform: translate(-100px, -50px) rotate(270deg); }
        }
        
        /* === SITE SELECTION PAGE === */
        .site-selection-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .site-selection-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 50px;
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-hover);
            text-align: center;
            animation: slideUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .site-selection-container h2 {
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .site-selection-container p {
            color: var(--text-gray);
            margin-bottom: 40px;
            font-size: 18px;
        }
        
        .site-cards-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .site-card {
            flex: 1;
            min-width: 300px;
            max-width: 350px;
            background: var(--primary-white);
            border-radius: 15px;
            padding: 50px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .site-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }
        
        .site-card i {
            font-size: 80px;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .site-card h3 {
            font-size: 36px;
            color: var(--primary-color);
            font-weight: 800;
        }
        
        .back-to-login-btn {
            background: var(--text-gray);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s;
        }
        
        .back-to-login-btn:hover {
            background: var(--text-dark);
            transform: translateY(-2px);
        }
        
        /* === MAIN APP === */
        .app-container { display: none; }
        .header { 
            background: var(--primary-white); 
            color: var(--text-dark); padding: 15px 25px; display: flex; 
            justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 100;
        }
        .header h1 { 
            font-size: 24px; display: flex; align-items: center; gap: 12px; 
            color: var(--primary-color); font-weight: 700;
        }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { 
            background: var(--primary-color); color: var(--primary-white); 
            border: none; padding: 10px 18px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; 
            transition: all 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { 
            background: var(--primary-dark); transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .switch-site-btn {
            background: var(--accent-color);
            color: var(--primary-white);
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .switch-site-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .container { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { 
            width: 280px; background: var(--primary-white); color: var(--text-dark); 
            padding: 25px 0;
            border-right: 1px solid var(--border-color); 
            box-shadow: 1px 0 5px rgba(0, 49, 53, 0.05);
            position: sticky; top: 70px; height: calc(100vh - 70px);
        }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { 
            padding: 18px 25px; cursor: pointer; transition: all 0.3s; 
            display: flex; align-items: center; gap: 15px; 
            border-left: 5px solid transparent;
            font-size: 16px; color: var(--text-gray);
            margin: 5px 0;
        }
        .sidebar-menu li:hover { 
            background: var(--secondary-light); 
            border-left-color: var(--primary-color); 
            color: var(--primary-color);
            transform: translateX(5px);
        }
        .sidebar-menu li.active { 
            background: var(--secondary-light); 
            border-left-color: var(--primary-color); 
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .main-content { flex: 1; padding: 25px; overflow-y: auto; background: var(--secondary-light); }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .section h2 { 
            margin-bottom: 25px; color: var(--primary-color); padding-bottom: 15px; 
            border-bottom: 2px solid var(--primary-color); 
            display: flex; align-items: center; gap: 12px;
            font-weight: 700;
        }
        
        /* === STATS CARDS === */
        .stats-container { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card { 
            background: var(--primary-white); padding: 25px; border-radius: 12px; 
            box-shadow: var(--shadow); text-align: center;
            border-top: 5px solid var(--primary-color);
            transition: all 0.3s;
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        .stat-value { font-size: 36px; font-weight: 800; color: var(--primary-color); margin: 10px 0; }
        .stat-label { color: var(--text-gray); font-size: 15px; font-weight: 600; }
        
        /* === ACTION BAR === */
        .actions-bar { 
            background: var(--primary-white); padding: 20px; border-radius: 12px; 
            box-shadow: var(--shadow); margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center; gap: 20px;
        }
        .search-filter { display: flex; gap: 15px; flex-wrap: wrap; }
        .search-box, .filter-select { 
            padding: 12px 18px; border: 2px solid var(--border-color); border-radius: 8px; 
            font-size: 15px; min-width: 220px; background: var(--primary-white);
            color: var(--text-dark);
        }
        .search-box:focus, .filter-select:focus { 
            border-color: var(--primary-color); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(0, 49, 53, 0.1);
        }
        
        .action-buttons { display: flex; gap: 12px; }
        .btn { 
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 600; display: flex; align-items: center; gap: 10px;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn-primary { background: var(--primary-color); color: var(--primary-white); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: var(--text-dark); }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-purple { background: #6f42c1; color: white; }
        .btn-excel { background: #1D6F42; color: white; }
        .btn-excel:hover { background: #155d32; }
        .btn-sm { padding: 8px 12px; font-size: 14px; }
        
        /* === INVENTORY TABLE === */
        .table-container { 
            background: var(--primary-white); border-radius: 12px; 
            box-shadow: var(--shadow); overflow: hidden;
        }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table th { 
            background: var(--secondary-light); padding: 18px; text-align: left; 
            color: var(--primary-color); font-weight: 700; border-bottom: 2px solid var(--border-color);
        }
        .inventory-table td { 
            padding: 16px; border-bottom: 1px solid var(--border-color); color: var(--text-dark);
        }
        .inventory-table tr { cursor: pointer; transition: all 0.3s; }
        .inventory-table tr:hover { background: var(--secondary-light); }
        
        .status-badge { 
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .status-active { background: rgba(40, 167, 69, 0.1); color: var(--success-color); }
        .status-failed { background: rgba(220, 53, 69, 0.1); color: var(--danger-color); }
        .status-replaced { background: rgba(255, 193, 7, 0.1); color: var(--warning-color); }
        .status-fixed { background: rgba(23, 162, 184, 0.1); color: var(--info-color); }
        
        /* === FORMS === */
        .form-container { 
            background: var(--primary-white); padding: 30px; border-radius: 12px; 
            box-shadow: var(--shadow);
        }
        .form-group { margin-bottom: 22px; }
        .form-group label { 
            display: block; margin-bottom: 10px; font-weight: 600; 
            color: var(--primary-color); display: flex; align-items: center; gap: 10px;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 14px; border: 2px solid var(--border-color); 
            border-radius: 8px; font-size: 15px; transition: all 0.3s;
            background: var(--primary-white); color: var(--text-dark);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(0, 49, 53, 0.1);
        }
        .form-row { display: flex; gap: 25px; margin-bottom: 22px; }
        .form-row .form-group { flex: 1; }
        
        /* === SOFTWARE LICENSES === */
        .software-licenses-container {
            margin: 25px 0;
            padding: 20px;
            background: var(--secondary-light);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .software-license {
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .software-license-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .software-license-header h4 {
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .remove-software-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-software-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        
        .add-software-btn:hover {
            background: var(--primary-dark);
        }
        
        /* === NETWORK INTERFACES === */
        .network-interfaces-container {
            margin: 25px 0;
            padding: 20px;
            background: var(--secondary-light);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .network-interface {
            background: var(--primary-white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .network-interface-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .network-interface-header h4 {
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .remove-network-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-network-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        
        .add-network-btn:hover {
            background: var(--primary-dark);
        }
        
        /* === SPECIFICATIONS GRID === */
        .specs-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 25px;
        }
        .spec-card { 
            background: var(--secondary-light); padding: 20px; border-radius: 10px; 
            border-left: 4px solid var(--primary-color);
        }
        .spec-card label { 
            display: block; margin-bottom: 10px; font-weight: 600; 
            color: var(--primary-color); display: flex; align-items: center; gap: 10px;
        }
        .spec-card input { 
            width: 100%; padding: 12px; border: 2px solid var(--border-color); 
            border-radius: 8px; font-size: 15px; background: var(--primary-white); 
            color: var(--text-dark);
        }
        
        /* === LOGS === */
        .logs-container { 
            background: var(--primary-white); padding: 25px; border-radius: 12px; 
            box-shadow: var(--shadow); max-height: 500px; overflow-y: auto;
        }
        .log-entry { 
            padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; gap: 18px;
            transition: all 0.3s;
        }
        .log-entry:hover { background: var(--secondary-light); }
        .log-icon { color: var(--primary-color); font-size: 20px; margin-top: 3px; }
        .log-timestamp { color: var(--text-gray); font-size: 13px; margin-bottom: 5px; }
        .log-action { font-weight: 700; color: var(--primary-color); margin-bottom: 5px; }
        .log-details { color: var(--text-dark); }
        
        /* === DEVICE DETAILS MODAL === */
        .device-details-modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            z-index: 1000; justify-content: center; align-items: center;
            animation: fadeIn 0.3s;
        }
        .device-details-content { 
            background: var(--primary-white); padding: 0; border-radius: 15px; 
            width: 95%; max-width: 1200px; height: 90vh; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-hover);
            position: relative;
        }
        .device-header { 
            background: var(--primary-white); padding: 25px; 
            border-bottom: 2px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .device-header h2 { color: var(--primary-color); margin: 0; }
        .close-details { 
            background: none; border: none; font-size: 32px; 
            cursor: pointer; color: var(--text-gray); transition: color 0.3s;
        }
        .close-details:hover { color: var(--primary-color); }
        
        .device-body { padding: 30px; }
        .device-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; margin-bottom: 30px;
        }
        .device-section { 
            background: var(--secondary-light); padding: 25px; border-radius: 10px; 
            border: 1px solid var(--border-color);
        }
        .device-section h3 { 
            color: var(--primary-color); margin-bottom: 20px; padding-bottom: 12px; 
            border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 12px;
        }
        .device-item { 
            display: flex; padding: 15px 0; 
            border-bottom: 1px solid var(--border-color);
        }
        .device-item:last-child { border-bottom: none; }
        .device-label { 
            width: 180px; font-weight: 600; color: var(--text-gray); 
            display: flex; align-items: center; gap: 10px;
        }
        .device-value { 
            flex: 1; color: var(--text-dark); font-weight: 500; 
            word-break: break-word;
        }
        
        /* === SOFTWARE IN MODAL === */
        .software-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .software-card {
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .software-card h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .software-detail {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .software-label {
            font-weight: 600;
            color: var(--text-gray);
            min-width: 120px;
        }
        
        .software-value {
            color: var(--text-dark);
        }
        
        /* === REPAIR HISTORY === */
        .repair-history-container {
            margin-top: 25px;
            padding: 20px;
            background: var(--secondary-light);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .repair-history-item {
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .failure-report-item {
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--danger-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .repair-history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .repair-history-date {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .repair-history-technician {
            color: var(--text-gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .repair-history-notes {
            color: var(--text-dark);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* === NETWORK INTERFACES IN MODAL === */
        .network-interfaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .network-interface-card {
            background: var(--primary-white);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .network-interface-card h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .interface-detail {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .interface-label {
            font-weight: 600;
            color: var(--text-gray);
            min-width: 100px;
        }
        
        .interface-value {
            color: var(--text-dark);
        }
        
        /* === SPECS GRID IN MODAL === */
        .specs-grid-modal { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin: 25px 0;
        }
        .spec-item { 
            background: var(--primary-white); padding: 20px; border-radius: 8px; 
            border: 1px solid var(--border-color); box-shadow: var(--shadow);
        }
        .spec-icon { 
            width: 50px; height: 50px; background: var(--primary-color); 
            border-radius: 10px; display: flex; align-items: center; 
            justify-content: center; margin-bottom: 15px; color: var(--primary-white);
            font-size: 24px;
        }
        .spec-name { 
            color: var(--text-gray); font-weight: 600; margin-bottom: 8px;
            font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
        }
        .spec-value { color: var(--text-dark); font-size: 18px; font-weight: 500; }
        
        /* === ACTIONS IN MODAL === */
        .device-actions { 
            margin-top: 30px; padding-top: 30px; 
            border-top: 2px solid var(--border-color);
            display: flex; gap: 15px; justify-content: center;
            flex-wrap: wrap;
        }
        
        /* === OTHER MODALS === */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content { 
            background: var(--primary-white); padding: 30px; border-radius: 15px; 
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-hover);
        }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color);
        }
        .modal-header h3 { color: var(--primary-color); margin: 0; }
        .close-modal { 
            background: none; border: none; font-size: 28px; 
            cursor: pointer; color: var(--text-gray); transition: color 0.3s;
        }
        .close-modal:hover { color: var(--primary-color); }
        
        /* === NETWORK DIAGRAM === */
        .network-diagram-container { 
            background: var(--primary-white); padding: 50px 30px; border-radius: 12px; 
            box-shadow: var(--shadow); text-align: center;
        }
        .diagram-btn { 
            padding: 18px 35px; font-size: 18px; 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); 
            color: var(--primary-white); border: none; border-radius: 10px; cursor: pointer; 
            transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 15px; margin-top: 20px; font-weight: 600;
        }
        .diagram-btn:hover { 
            transform: translateY(-3px); box-shadow: var(--shadow-hover);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        }
        
        /* === EXCEL IMPORT/EXPORT === */
        .excel-import-container {
            background: var(--primary-white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        
        .excel-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .template-download {
            margin-top: 25px;
            padding: 20px;
            background: var(--secondary-light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .template-download h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* === FIREBASE STATUS === */
        .firebase-status { 
            position: fixed; bottom: 20px; right: 20px; padding: 10px 18px; 
            border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 10px;
            box-shadow: var(--shadow);
        }
        .status-connected { background: rgba(40, 167, 69, 0.1); color: var(--success-color); border: 1px solid var(--success-color); }
        .status-disconnected { background: rgba(220, 53, 69, 0.1); color: var(--danger-color); border: 1px solid var(--danger-color); }
        
        /* === NO DATA MESSAGE === */
        .no-data { 
            text-align: center; padding: 50px; background: var(--primary-white); 
            border-radius: 12px; box-shadow: var(--shadow);
        }
        
        /* === FAILED DEVICES TABLE === */
        .failure-table { width: 100%; border-collapse: collapse; }
        .failure-table th { 
            background: var(--secondary-light); padding: 18px; text-align: left; 
            color: var(--primary-color); font-weight: 700; border-bottom: 2px solid var(--border-color);
        }
        .failure-table td { 
            padding: 16px; border-bottom: 1px solid var(--border-color); color: var(--text-dark);
        }
        .failure-table tr:hover { background: var(--secondary-light); }
        
        /* === RESPONSIVE DESIGN === */
        @media (max-width: 992px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; padding: 15px 0; height: auto; position: static; }
            .sidebar-menu { display: flex; overflow-x: auto; }
            .sidebar-menu li { white-space: nowrap; border-left: none; border-bottom: 4px solid transparent; }
            .sidebar-menu li.active, .sidebar-menu li:hover { border-left: none; border-bottom-color: var(--primary-color); }
            .form-row { flex-direction: column; gap: 0; }
            .actions-bar { flex-direction: column; align-items: stretch; }
            .search-filter { width: 100%; }
            .search-box, .filter-select { min-width: 100%; }
            .specs-grid { grid-template-columns: 1fr; }
            .device-grid { grid-template-columns: 1fr; }
            .specs-grid-modal { grid-template-columns: repeat(2, 1fr); }
            .software-grid { grid-template-columns: 1fr; }
            .network-interfaces-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .login-box { width: 95%; padding: 30px; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header h1 { font-size: 22px; }
            .stats-container { grid-template-columns: repeat(2, 1fr); }
            .device-item { flex-direction: column; gap: 8px; }
            .device-label { width: 100%; }
            .specs-grid-modal { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .stats-container { grid-template-columns: 1fr; }
            .action-buttons { flex-wrap: wrap; }
            .btn { width: 100%; justify-content: center; }
            .device-actions { flex-direction: column; }
        }
        
        /* === ANIMATIONS === */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 49, 53, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 49, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 49, 53, 0); }
        }
        
        .pulse { animation: pulse 2s infinite; }
        
        /* === FORM CONTROLS === */
        .form-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-container" id="loginPage">
        <div class="login-animation"></div>
        <div class="login-animation"></div>
        <div class="login-animation"></div>
        
        <div class="login-box">
            <h2><i class="fas fa-laptop-house"></i> IT Management Interface</h2>
            <p>Enter your credentials to access the system</p>
            <div class="input-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" placeholder="Enter username" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
            </div>
            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login to System
            </button>
            <div class="error-message" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Invalid username or password
            </div>
        </div>
    </div>

    <!-- SITE SELECTION PAGE -->
    <div class="site-selection-page" id="siteSelectionPage">
        <div class="site-selection-container">
            <h2><i class="fas fa-building"></i> Select Your Site</h2>
            <p>Choose which site you want to manage</p>
            
            <div class="site-cards-container">
                <div class="site-card" id="wtcCard">
                    <i class="fas fa-building"></i>
                    <h3>WTC</h3>
                </div>
                
                <div class="site-card" id="hlsCard">
                    <i class="fas fa-city"></i>
                    <h3>HLS</h3>
                </div>
            </div>
            
            <button class="back-to-login-btn" id="backToLoginBtn">
                <i class="fas fa-arrow-left"></i> Back to Login
            </button>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <h1><i class="fas fa-laptop-house"></i> <span id="siteTitle">IT Management Interface</span></h1>
            <div class="user-info">
                <span>Welcome, <strong id="currentUserName" style="color: var(--primary-color);">Adithya</strong></span>
                <button class="switch-site-btn" id="switchSiteBtn">
                    <i class="fas fa-exchange-alt"></i> Switch Site
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="container">
            <!-- SIDEBAR MENU -->
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li class="active" data-section="inventory">
                        <i class="fas fa-laptop"></i> Device Inventory
                    </li>
                    <li data-section="addDevice">
                        <i class="fas fa-plus-circle"></i> Add New Device
                    </li>
                    <li data-section="reportFailure">
                        <i class="fas fa-exclamation-triangle"></i> Report Failure
                    </li>
                    <li data-section="failedDevices">
                        <i class="fas fa-tools"></i> Failed Devices
                    </li>
                    <li data-section="replaceDevice">
                        <i class="fas fa-exchange-alt"></i> Replace Device
                    </li>
                    <li data-section="excelImport">
                        <i class="fas fa-file-excel"></i> Excel Import/Export
                    </li>
                    <li data-section="logs">
                        <i class="fas fa-history"></i> Activity Logs
                    </li>
                    <li data-section="networkDiagram">
                        <i class="fas fa-project-diagram"></i> Network Diagram
                    </li>
                </ul>
            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- INVENTORY SECTION -->
                <div class="section active" id="inventory">
                    <h2><i class="fas fa-laptop"></i> Device Inventory Dashboard</h2>
                    
                    <!-- STATISTICS -->
                    <div class="stats-container">
                        <div class="stat-card" id="totalDevicesCard">
                            <div class="stat-value" id="totalDevices">0</div>
                            <div class="stat-label">Total Devices</div>
                        </div>
                        <div class="stat-card" id="activeDevicesCard">
                            <div class="stat-value" id="activeDevices">0</div>
                            <div class="stat-label">Active Devices</div>
                        </div>
                        <div class="stat-card" id="failedDevicesCard">
                            <div class="stat-value" id="failedDevices">0</div>
                            <div class="stat-label">Failed Devices</div>
                        </div>
                        <div class="stat-card" id="replacedDevicesCard">
                            <div class="stat-value" id="replacedDevices">0</div>
                            <div class="stat-label">Replaced Devices</div>
                        </div>
                    </div>

                    <!-- ACTION BAR -->
                    <div class="actions-bar">
                        <div class="search-filter">
                            <input type="text" class="search-box" id="searchBox" 
                                   placeholder="Search PC Number, Serial, or User...">
                            <select class="filter-select" id="departmentFilter">
                                <option value="">All Departments</option>
                                <!-- Departments will be populated based on site -->
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="addNewBtn">
                                <i class="fas fa-plus"></i> Add Device
                            </button>
                            <button class="btn btn-excel" id="exportBtn">
                                <i class="fas fa-file-export"></i> Export to Excel
                            </button>
                            <button class="btn btn-info" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- INVENTORY TABLE -->
                    <div class="table-container">
                        <table class="inventory-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>PC Number</th>
                                    <th>PC Model</th>
                                    <th>IP Address</th>
                                    <th>Department</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Data loaded by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="no-data" id="noDataMessage" style="display: none;">
                        <i class="fas fa-laptop" style="font-size: 60px; color: var(--border-color); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-gray); margin-bottom: 10px;">No Devices Found</h3>
                        <p style="color: var(--text-gray);">Click "Add Device" to add your first inventory item</p>
                    </div>
                </div>

                <!-- ADD DEVICE SECTION -->
                <div class="section" id="addDevice">
                    <h2><i class="fas fa-plus-circle"></i> Add New Device</h2>
                    <div class="form-container">
                        <form id="deviceForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pcNumber"><i class="fas fa-hashtag"></i> PC Number *</label>
                                    <input type="text" id="pcNumber" placeholder="PC-001" required class="form-field" tabindex="1">
                                </div>
                                <div class="form-group">
                                    <label for="pcModel"><i class="fas fa-laptop"></i> PC Model *</label>
                                    <input type="text" id="pcModel" placeholder="Dell OptiPlex 7080" required class="form-field" tabindex="2">
                                </div>
                            </div>

                            <!-- NETWORK INTERFACES SECTION -->
                            <div class="network-interfaces-container" id="networkInterfacesContainer">
                                <h3 style="color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-network-wired"></i> Network Interfaces
                                </h3>
                                <div id="networkInterfacesList">
                                    <!-- Network interfaces will be added here -->
                                </div>
                                <button type="button" class="add-network-btn" id="addNetworkInterfaceBtn">
                                    <i class="fas fa-plus"></i> Add Network Interface
                                </button>
                            </div>

                            <!-- SOFTWARE LICENSES SECTION -->
                            <div class="software-licenses-container" id="softwareLicensesContainer">
                                <h3 style="color: var(--primary-color); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-copyright"></i> Licensed Software
                                </h3>
                                <div id="softwareLicensesList">
                                    <!-- Software licenses will be added here -->
                                </div>
                                <button type="button" class="add-software-btn" id="addSoftwareLicenseBtn">
                                    <i class="fas fa-plus"></i> Add Software License
                                </button>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="department"><i class="fas fa-building"></i> Department *</label>
                                    <select id="department" required class="form-field" tabindex="3">
                                        <option value="">Select Department</option>
                                        <!-- Departments will be populated based on site -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="userName"><i class="fas fa-user"></i> User Name</label>
                                    <input type="text" id="userName" placeholder="User's name" class="form-field" tabindex="4">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pcSerial"><i class="fas fa-barcode"></i> PC Serial Number *</label>
                                    <input type="text" id="pcSerial" placeholder="Serial number" required class="form-field" tabindex="5">
                                </div>
                            </div>

                            <!-- SPECIFICATIONS GRID -->
                            <div class="specs-grid">
                                <div class="spec-card">
                                    <label><i class="fas fa-microchip"></i> CPU</label>
                                    <input type="text" id="cpu" placeholder="e.g., Intel i7-10700" class="form-field" tabindex="6">
                                </div>
                                <div class="spec-card">
                                    <label><i class="fas fa-gamepad"></i> GPU</label>
                                    <input type="text" id="gpu" placeholder="e.g., NVIDIA GTX 1660" class="form-field" tabindex="7">
                                </div>
                                <div class="spec-card">
                                    <label><i class="fas fa-memory"></i> RAM</label>
                                    <input type="text" id="ram" placeholder="e.g., 16GB DDR4" class="form-field" tabindex="8">
                                </div>
                                <div class="spec-card">
                                    <label><i class="fas fa-hdd"></i> Storage</label>
                                    <input type="text" id="storage" placeholder="e.g., 512GB SSD" class="form-field" tabindex="9">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="monitorModel"><i class="fas fa-tv"></i> Monitor Model</label>
                                    <input type="text" id="monitorModel" placeholder="Monitor model" class="form-field" tabindex="10">
                                </div>
                                <div class="form-group">
                                    <label for="monitorSerial"><i class="fas fa-hashtag"></i> Monitor Serial</label>
                                    <input type="text" id="monitorSerial" placeholder="Monitor serial number" class="form-field" tabindex="11">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="status"><i class="fas fa-info-circle"></i> Device Status</label>
                                <select id="status" class="form-field" tabindex="12">
                                    <option value="active">Active</option>
                                    <option value="failed">Failed</option>
                                    <option value="replaced">Replaced</option>
                                </select>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success" id="saveDeviceBtn">
                                    <i class="fas fa-save"></i> Save Device
                                </button>
                                <button type="button" class="btn btn-warning" id="cancelBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- REPORT FAILURE SECTION -->
                <div class="section" id="reportFailure">
                    <h2><i class="fas fa-exclamation-triangle"></i> Report Device Failure</h2>
                    <div class="form-container">
                        <form id="failureReportForm">
                            <div class="form-group">
                                <label for="failureDevice"><i class="fas fa-laptop"></i> Select Device *</label>
                                <select id="failureDevice" required class="form-field" tabindex="1">
                                    <option value="">Select a device to report failure</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="failureReason"><i class="fas fa-comment-medical"></i> Failure Reason *</label>
                                <textarea id="failureReason" rows="4" placeholder="Describe the issue in detail..." required class="form-field" tabindex="2"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="failureDate"><i class="fas fa-calendar-alt"></i> Failure Date *</label>
                                    <input type="date" id="failureDate" required class="form-field" tabindex="3">
                                </div>
                                <div class="form-group">
                                    <label for="reportedBy"><i class="fas fa-user-check"></i> Reported By *</label>
                                    <select id="reportedBy" required class="form-field" tabindex="4">
                                        <option value="">Select Technician</option>
                                        <!-- Technicians will be populated based on site -->
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="failurePriority"><i class="fas fa-flag"></i> Priority Level</label>
                                <select id="failurePriority" class="form-field" tabindex="5">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-danger" id="reportFailureBtn">
                                    <i class="fas fa-exclamation-circle"></i> Report Failure
                                </button>
                                <button type="button" class="btn btn-warning" id="cancelFailureBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- FAILED DEVICES SECTION -->
                <div class="section" id="failedDevices">
                    <h2><i class="fas fa-tools"></i> Failed Devices Management</h2>
                    
                    <div class="actions-bar">
                        <div class="search-filter">
                            <input type="text" class="search-box" id="failedSearchBox" 
                                   placeholder="Search failed devices...">
                            <select class="filter-select" id="failedPriorityFilter">
                                <option value="">All Priorities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-info" id="refreshFailedBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="failure-table" id="failedDevicesTable">
                            <thead>
                                <tr>
                                    <th>PC Number</th>
                                    <th>PC Model</th>
                                    <th>Department</th>
                                    <th>Failure Reason</th>
                                    <th>Reported By</th>
                                    <th>Priority</th>
                                    <th>Failure Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="failedDevicesTableBody">
                                <!-- Failed devices loaded by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="no-data" id="noFailedDataMessage" style="display: none;">
                        <i class="fas fa-check-circle" style="font-size: 60px; color: var(--border-color); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-gray); margin-bottom: 10px;">No Failed Devices Found</h3>
                        <p style="color: var(--text-gray);">All devices are currently operational</p>
                    </div>
                </div>

                <!-- REPLACE DEVICE SECTION -->
                <div class="section" id="replaceDevice">
                    <h2><i class="fas fa-exchange-alt"></i> Replace Device</h2>
                    <div class="form-container">
                        <form id="replaceDeviceForm">
                            <div class="form-group">
                                <label for="replaceDeviceSelect"><i class="fas fa-laptop"></i> Select Device to Replace *</label>
                                <select id="replaceDeviceSelect" required class="form-field" tabindex="1">
                                    <option value="">Select a device to replace</option>
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="replacementPcNumber"><i class="fas fa-desktop"></i> New PC Number *</label>
                                    <input type="text" id="replacementPcNumber" required class="form-field" tabindex="2">
                                </div>
                                <div class="form-group">
                                    <label for="replacementPcModel"><i class="fas fa-microchip"></i> New PC Model *</label>
                                    <input type="text" id="replacementPcModel" required class="form-field" tabindex="3">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="replacementSerial"><i class="fas fa-barcode"></i> New Serial Number *</label>
                                    <input type="text" id="replacementSerial" required class="form-field" tabindex="4">
                                </div>
                                <div class="form-group">
                                    <label for="replacementDate"><i class="fas fa-calendar-alt"></i> Replacement Date *</label>
                                    <input type="date" id="replacementDate" required class="form-field" tabindex="5">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="replacementReason"><i class="fas fa-comment-medical"></i> Replacement Reason</label>
                                <textarea id="replacementReason" rows="3" placeholder="Why is this device being replaced?" class="form-field" tabindex="6"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="replacedBy"><i class="fas fa-user-check"></i> Replaced By *</label>
                                <select id="replacedBy" required class="form-field" tabindex="7">
                                    <option value="">Select Technician</option>
                                    <!-- Technicians will be populated based on site -->
                                </select>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success" id="replaceDeviceBtn">
                                    <i class="fas fa-exchange-alt"></i> Replace Device
                                </button>
                                <button type="button" class="btn btn-warning" id="cancelReplaceFormBtn">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- EXCEL IMPORT/EXPORT SECTION -->
                <div class="section" id="excelImport">
                    <h2><i class="fas fa-file-excel"></i> Excel Import/Export</h2>
                    
                    <div class="excel-import-container">
                        <h3><i class="fas fa-file-export"></i> Export Data to Excel</h3>
                        <p>Export all devices data to an Excel file for backup or reporting purposes.</p>
                        
                        <div class="excel-actions">
                            <button class="btn btn-excel" id="exportAllBtn">
                                <i class="fas fa-file-export"></i> Export All Devices
                            </button>
                            <button class="btn btn-success" id="exportActiveBtn">
                                <i class="fas fa-file-export"></i> Export Active Devices
                            </button>
                            <button class="btn btn-danger" id="exportFailedBtn">
                                <i class="fas fa-file-export"></i> Export Failed Devices
                            </button>
                        </div>
                        
                        <div class="template-download">
                            <h4><i class="fas fa-download"></i> Download Template</h4>
                            <p>Download an Excel template with the correct format for importing devices.</p>
                            <button class="btn btn-info" id="downloadTemplateBtn">
                                <i class="fas fa-download"></i> Download Import Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="excel-import-container">
                        <h3><i class="fas fa-file-import"></i> Import Data from Excel</h3>
                        <p>Import devices from an Excel file. Make sure the file follows the template format.</p>
                        
                        <div class="excel-actions">
                            <div class="file-input-container">
                                <input type="file" id="excelFileInput" accept=".xlsx, .xls">
                                <label for="excelFileInput" class="file-input-label">
                                    <i class="fas fa-file-import"></i> Choose Excel File
                                </label>
                            </div>
                            <button class="btn btn-primary" id="importBtn" disabled>
                                <i class="fas fa-upload"></i> Import Devices
                            </button>
                        </div>
                        
                        <div id="importProgress" style="display: none; margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span id="importProgressText">Processing...</span>
                            </div>
                            <div style="margin-top: 10px; width: 100%; background: var(--secondary-light); border-radius: 4px; overflow: hidden;">
                                <div id="importProgressBar" style="height: 10px; background: var(--primary-color); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="importResults" style="margin-top: 15px;"></div>
                        </div>
                        
                        <div style="margin-top: 25px; padding: 20px; background: var(--secondary-light); border-radius: 8px; border: 1px solid var(--border-color);">
                            <h4><i class="fas fa-info-circle"></i> Import Instructions</h4>
                            <ol style="margin-left: 20px; margin-top: 10px; color: var(--text-gray);">
                                <li>Download the template above to see the required format</li>
                                <li>Required columns: PC Number, PC Model, PC Serial, Department</li>
                                <li>Optional columns: User Name, CPU, GPU, RAM, Storage, Monitor Model, Monitor Serial, Status</li>
                                <li>Status can be: active, failed, or replaced</li>
                                <li>Maximum 100 devices per import</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- ACTIVITY LOGS -->
                <div class="section" id="logs">
                    <h2><i class="fas fa-history"></i> Activity Logs</h2>
                    <div class="actions-bar">
                        <div class="search-filter">
                            <input type="text" class="search-box" id="logSearchBox" placeholder="Search logs...">
                            <select class="filter-select" id="logTypeFilter">
                                <option value="">All Actions</option>
                                <option value="Login">Login</option>
                                <option value="Device Added">Device Added</option>
                                <option value="Device Edited">Device Edited</option>
                                <option value="Device Deleted">Device Deleted</option>
                                <option value="Device Failure Reported">Device Failure Reported</option>
                                <option value="Device Fixed">Device Fixed</option>
                                <option value="Device Replaced">Device Replaced</option>
                                <option value="Excel Import">Excel Import</option>
                                <option value="Excel Export">Excel Export</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-excel" id="exportLogsBtn">
                                <i class="fas fa-file-export"></i> Export Logs to Excel
                            </button>
                            <button class="btn btn-info" id="refreshLogsBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="logs-container" id="logsContainer">
                        <!-- Logs will load here -->
                    </div>
                </div>

                <!-- NETWORK DIAGRAM -->
                <div class="section" id="networkDiagram">
                    <h2><i class="fas fa-project-diagram"></i> Network Diagram</h2>
                    <div class="network-diagram-container">
                        <h3>Network Infrastructure Diagram</h3>
                        <p>Access the complete network diagram showing all connections and devices</p>
                        <button class="diagram-btn" id="viewDiagramBtn">
                            <i class="fas fa-external-link-alt"></i> Open Network Diagram
                        </button>
                        <div style="margin-top: 30px; padding: 20px; background: var(--secondary-light); border-radius: 8px;">
                            <p style="color: var(--text-gray);">
                                <i class="fas fa-link"></i> URL: 
                                <code style="color: var(--primary-color);" id="networkDiagramUrl">Loading...</code>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DEVICE DETAILS MODAL (FULL SCREEN) -->
    <div class="device-details-modal" id="deviceDetailsModal">
        <div class="device-details-content">
            <div class="device-header">
                <h2><i class="fas fa-laptop"></i> Device Details</h2>
                <button class="close-details" id="closeDetailsModal">&times;</button>
            </div>
            <div class="device-body" id="deviceDetailsContent">
                <!-- Details loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-trash-alt"></i> Delete Device</h3>
                <button class="close-modal" id="closeDeleteModal">&times;</button>
            </div>
            <div id="deleteModalContent">
                <!-- Delete confirmation loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- MARK AS FIXED MODAL -->
    <div class="modal" id="markFixedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-wrench"></i> Mark Device as Fixed</h3>
                <button class="close-modal" id="closeMarkFixedModal">&times;</button>
            </div>
            <div id="markFixedModalContent">
                <!-- Mark as fixed form loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- REPAIR HISTORY MODAL -->
    <div class="modal" id="repairHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Repair History & Failure Reports</h3>
                <button class="close-modal" id="closeRepairHistoryModal">&times;</button>
            </div>
            <div id="repairHistoryModalContent">
                <!-- Repair history and failure reports loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- FIREBASE STATUS INDICATOR -->
    <div id="firebaseStatus" class="firebase-status status-disconnected">
        <i class="fas fa-plug"></i>
        <span>Firebase: Disconnected</span>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyC7GcDDHQqUsOVKrkux7WaSpH7gzYHEsXU",
            authDomain: "inventory-3650f.firebaseapp.com",
            databaseURL: "https://inventory-3650f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "inventory-3650f",
            storageBucket: "inventory-3650f.firebasestorage.app",
            messagingSenderId: "788791862955",
            appId: "1:788791862955:web:280dc7b46f9ee5eb1a79ee",
            measurementId: "G-1NTLEP3DFE"
        };

        // ============================================
        // INITIALIZE FIREBASE
        // ============================================
        let app, db, auth;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            updateFirebaseStatus(true);
            console.log(" Firebase initialized successfully");
        } catch (error) {
            console.error(" Firebase initialization error:", error);
            updateFirebaseStatus(false);
        }

        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.className = "firebase-status status-connected";
                statusElement.innerHTML = '<i class="fas fa-plug"></i><span>Firebase: Connected</span>';
            } else {
                statusElement.className = "firebase-status status-disconnected";
                statusElement.innerHTML = '<i class="fas fa-plug"></i><span>Firebase: Disconnected</span>';
            }
        }

        // ============================================
        // SITE CONFIGURATION
        // ============================================
        const siteConfig = {
            wtc: {
                name: "WTC",
                fullName: "Wijeya Television Corporation",
                icon: "fas fa-building",
                technicians: ["Adithya", "Minosh", "Niluksha", "Gayan"],
                departments: ["Engineering", "NEWS", "Scheduling", "MCR", "PCR 1", "PCR 2", "Marketing A/B", "Marketing C", "Research", "Political", "GFX", "Transmission"],
                networkDiagram: "https://www.canva.com/design/DAG-MlkG1Bs/fTfu6FEhnj8pTLDKAXJZcQ/view?utm_content=DAG-MlkG1Bs&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h150b286d2a",
                firebaseCollection: "devices_wtc",
                logsCollection: "activityLogs_wtc",
                repairCollection: "repairHistory_wtc"
            },
            hls: {
                name: "HLS",
                fullName: "Hiru Live Streaming",
                icon: "fas fa-city",
                technicians: ["Navendra"],
                departments: ["Production", "PCR", "Engineering", "Camera"],
                networkDiagram: "https://www.canva.com/design/DAG-e1F-ViA/nsJaRxmGmBmsY19qmF0SCg/view?utm_content=DAG-e1F-ViA&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h89c18793db",
                firebaseCollection: "devices_hls",
                logsCollection: "activityLogs_hls",
                repairCollection: "repairHistory_hls"
            }
        };

        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentSite = null;
        let inventoryData = [];
        let activityLogs = [];
        let currentDeviceId = null;
        let isEditMode = false;
        let currentUser = "";
        let realTimeUnsubscribe = null;
        let logsUnsubscribe = null;

        // ============================================
        // TIMEZONE FUNCTIONS (Sri Lanka UTC+5:30)
        // ============================================
        function getSriLankaTime() {
            return new Date();
        }

        function formatSriLankaTimestamp(date) {
            // Format: YYYY-MM-DD HH:MM:SS (Sri Lanka Time)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function formatDateTime(date) {
            // Format for repair history: YYYY-MM-DD HH:MM
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // ============================================
        // FIREBASE FUNCTIONS WITH SITE SUPPORT
        // ============================================
        async function saveDeviceToFirebase(deviceData) {
            if (!currentSite) return null;
            try {
                const deviceRef = await db.collection(currentSite.firebaseCollection).add({
                    ...deviceData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser,
                    site: currentSite.name
                });
                return deviceRef.id;
            } catch (error) {
                console.error("Error saving device:", error);
                return null;
            }
        }

        async function updateDeviceInFirebase(deviceId, deviceData) {
            if (!currentSite) return false;
            try {
                await db.collection(currentSite.firebaseCollection).doc(deviceId).update({
                    ...deviceData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser
                });
                return true;
            } catch (error) {
                console.error("Error updating device:", error);
                return false;
            }
        }

        async function deleteDeviceFromFirebase(deviceId) {
            if (!currentSite) return false;
            try {
                await db.collection(currentSite.firebaseCollection).doc(deviceId).delete();
                return true;
            } catch (error) {
                console.error("Error deleting device:", error);
                return false;
            }
        }

        async function addLogToFirebase(logEntry) {
            if (!currentSite) return false;
            try {
                const sriLankaTime = getSriLankaTime();
                const timestamp = formatSriLankaTimestamp(sriLankaTime);
                
                await db.collection(currentSite.logsCollection).add({
                    action: logEntry.action,
                    details: logEntry.details,
                    user: logEntry.user,
                    site: currentSite.name,
                    timestamp: timestamp,
                    sriLankaTimestamp: timestamp,
                    date: sriLankaTime.toISOString().split('T')[0],
                    hour: sriLankaTime.getHours(),
                    minute: sriLankaTime.getMinutes()
                });
                console.log(" Log saved to Firebase:", logEntry.action, "at", timestamp);
                return true;
            } catch (error) {
                console.error(" Error saving log:", error);
                return false;
            }
        }

        async function loadDevicesFromFirebase() {
            if (!currentSite) return [];
            try {
                const snapshot = await db.collection(currentSite.firebaseCollection)
                    .orderBy('createdAt', 'desc')
                    .get();
                const devices = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    devices.push({
                        id: doc.id,
                        ...data
                    });
                });
                return devices;
            } catch (error) {
                console.error("Error loading devices:", error);
                return [];
            }
        }

        async function loadLogsFromFirebase() {
            if (!currentSite) return [];
            try {
                const snapshot = await db.collection(currentSite.logsCollection)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();
                
                const logs = [];
                
                if (snapshot.empty) {
                    console.log("No logs found in database");
                    return logs;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    let timestamp = data.sriLankaTimestamp || data.timestamp || formatSriLankaTimestamp(getSriLankaTime());
                    
                    if (timestamp && timestamp.toDate) {
                        try {
                            const date = timestamp.toDate();
                            timestamp = formatSriLankaTimestamp(date);
                        } catch (e) {
                            console.error("Error converting timestamp:", e);
                        }
                    }
                    
                    logs.push({
                        id: doc.id,
                        timestamp: timestamp,
                        action: data.action || 'Unknown Action',
                        details: data.details || '',
                        user: data.user || 'System',
                        site: data.site || currentSite.name
                    });
                });
                
                console.log(` Loaded ${logs.length} logs from Firebase (Sri Lanka Time)`);
                return logs;
            } catch (error) {
                console.error(" Error loading logs:", error);
                return getSampleLogs();
            }
        }

        // ============================================
        // REPAIR HISTORY & FAILURE REPORTS FUNCTIONS
        // ============================================
        async function addRepairHistoryEntry(deviceId, repairData) {
            if (!currentSite) return null;
            try {
                const repairRef = await db.collection(currentSite.repairCollection).add({
                    deviceId: deviceId,
                    site: currentSite.name,
                    ...repairData,
                    repairedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    repairedBy: currentUser
                });
                
                await db.collection(currentSite.firebaseCollection).doc(deviceId).update({
                    lastRepairDate: repairData.date,
                    lastRepairBy: repairData.repairedBy,
                    lastRepairNotes: repairData.notes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return repairRef.id;
            } catch (error) {
                console.error("Error saving repair history:", error);
                return null;
            }
        }

        async function loadRepairHistory(deviceId) {
            if (!currentSite) return [];
            try {
                const snapshot = await db.collection(currentSite.repairCollection)
                    .where('deviceId', '==', deviceId)
                    .orderBy('repairedAt', 'desc')
                    .get();
                
                const repairs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    let repairedAt = formatDateTime(getSriLankaTime());
                    if (data.repairedAt && data.repairedAt.toDate) {
                        try {
                            const date = data.repairedAt.toDate();
                            repairedAt = formatDateTime(new Date(date.getTime() + (5.5 * 3600000)));
                        } catch (e) {
                            console.error("Error converting repair date:", e);
                        }
                    } else if (data.date) {
                        repairedAt = data.date;
                    }
                    
                    repairs.push({
                        id: doc.id,
                        date: repairedAt,
                        repairedBy: data.repairedBy || currentUser,
                        notes: data.notes || '',
                        status: data.status || 'fixed'
                    });
                });
                
                return repairs;
            } catch (error) {
                console.error("Error loading repair history:", error);
                return [];
            }
        }

        // ============================================
        // EXCEL IMPORT/EXPORT FUNCTIONS
        // ============================================
        function exportToExcel(data, filename = 'devices') {
            try {
                // Prepare data for Excel
                const excelData = data.map(device => {
                    // Flatten network interfaces
                    let networkInfo = 'N/A';
                    if (device.networkInterfaces && device.networkInterfaces.length > 0) {
                        networkInfo = device.networkInterfaces.map(iface => 
                            `${iface.interfaceName || 'Interface'}: ${iface.ipAddress || 'N/A'}`
                        ).join('; ');
                    }
                    
                    // Flatten software licenses
                    let softwareInfo = 'N/A';
                    if (device.softwareLicenses && device.softwareLicenses.length > 0) {
                        softwareInfo = device.softwareLicenses.map(software => 
                            `${software.name || 'Software'} ${software.version || ''}`
                        ).join('; ');
                    }
                    
                    return {
                        'PC Number': device.pcNumber || 'N/A',
                        'PC Model': device.pcModel || 'N/A',
                        'PC Serial': device.pcSerial || 'N/A',
                        'Department': device.department || 'N/A',
                        'User Name': device.userName || 'N/A',
                        'IP Address': networkInfo,
                        'CPU': device.cpu || 'N/A',
                        'GPU': device.gpu || 'N/A',
                        'RAM': device.ram || 'N/A',
                        'Storage': device.storage || 'N/A',
                        'Monitor Model': device.monitorModel || 'N/A',
                        'Monitor Serial': device.monitorSerial || 'N/A',
                        'Status': device.status || 'active',
                        'Software Licenses': softwareInfo,
                        'Created By': device.createdBy || 'N/A',
                        'Created Date': device.createdAt ? (device.createdAt.toDate ? device.createdAt.toDate().toLocaleDateString() : device.createdAt) : 'N/A',
                        'Updated By': device.updatedBy || 'N/A',
                        'Updated Date': device.updatedAt ? (device.updatedAt.toDate ? device.updatedAt.toDate().toLocaleDateString() : device.updatedAt) : 'N/A'
                    };
                });

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                const wscols = [
                    { wch: 15 }, // PC Number
                    { wch: 25 }, // PC Model
                    { wch: 20 }, // PC Serial
                    { wch: 20 }, // Department
                    { wch: 20 }, // User Name
                    { wch: 25 }, // IP Address
                    { wch: 25 }, // CPU
                    { wch: 25 }, // GPU
                    { wch: 15 }, // RAM
                    { wch: 20 }, // Storage
                    { wch: 20 }, // Monitor Model
                    { wch: 20 }, // Monitor Serial
                    { wch: 15 }, // Status
                    { wch: 30 }, // Software Licenses
                    { wch: 15 }, // Created By
                    { wch: 15 }, // Created Date
                    { wch: 15 }, // Updated By
                    { wch: 15 }  // Updated Date
                ];
                ws['!cols'] = wscols;

                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Devices');
                
                // Generate filename with site name and date
                const dateStr = new Date().toISOString().split('T')[0];
                const exportFilename = `${filename}_${currentSite.name}_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, exportFilename);
                
                return true;
            } catch (error) {
                console.error("Error exporting to Excel:", error);
                alert("Error exporting to Excel: " + error.message);
                return false;
            }
        }

        function downloadTemplate() {
            try {
                const templateData = [
                    {
                        'PC Number': 'PC-001',
                        'PC Model': 'Dell OptiPlex 7080',
                        'PC Serial': 'ABC123456',
                        'Department': 'Engineering',
                        'User Name': 'John Doe',
                        'CPU': 'Intel i7-10700',
                        'GPU': 'NVIDIA GTX 1660',
                        'RAM': '16GB DDR4',
                        'Storage': '512GB SSD',
                        'Monitor Model': 'Dell P2419H',
                        'Monitor Serial': 'MON123456',
                        'Status': 'active',
                        'Notes': 'Additional notes here'
                    }
                ];

                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Template');
                
                // Add instructions sheet
                const instructions = [
                    ['IMPORT INSTRUCTIONS'],
                    [''],
                    ['1. Required columns: PC Number, PC Model, PC Serial, Department'],
                    ['2. Status can be: active, failed, or replaced'],
                    ['3. All other columns are optional'],
                    ['4. Do not change the column headers'],
                    ['5. Maximum 100 devices per import'],
                    ['6. Remove this instructions sheet before importing'],
                    [''],
                    ['COLUMN DESCRIPTIONS'],
                    ['PC Number: Unique identifier for the device (e.g., PC-001)'],
                    ['PC Model: Model name/number (e.g., Dell OptiPlex 7080)'],
                    ['PC Serial: Serial number of the PC'],
                    ['Department: Department where device is located'],
                    ['User Name: Person using the device'],
                    ['CPU: Processor specifications'],
                    ['GPU: Graphics card specifications'],
                    ['RAM: Memory specifications'],
                    ['Storage: Storage specifications'],
                    ['Monitor Model: Monitor model name'],
                    ['Monitor Serial: Monitor serial number'],
                    ['Status: Device status (active/failed/replaced)'],
                    ['Notes: Any additional notes']
                ];
                
                const ws2 = XLSX.utils.aoa_to_sheet(instructions);
                XLSX.utils.book_append_sheet(wb, ws2, 'Instructions');
                
                XLSX.writeFile(wb, `Device_Import_Template_${currentSite.name}.xlsx`);
                
            } catch (error) {
                console.error("Error downloading template:", error);
                alert("Error downloading template: " + error.message);
            }
        }

        async function importFromExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (!jsonData || jsonData.length === 0) {
                            reject(new Error("No data found in the Excel file"));
                            return;
                        }
                        
                        if (jsonData.length > 100) {
                            reject(new Error("Maximum 100 devices allowed per import"));
                            return;
                        }
                        
                        const results = {
                            total: jsonData.length,
                            success: 0,
                            failed: 0,
                            errors: []
                        };
                        
                        // Process each row
                        for (let i = 0; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const rowNum = i + 2; // +2 because Excel rows start at 1 and we have header
                            
                            try {
                                // Validate required fields
                                if (!row['PC Number'] || !row['PC Model'] || !row['PC Serial'] || !row['Department']) {
                                    throw new Error("Missing required fields (PC Number, PC Model, PC Serial, or Department)");
                                }
                                
                                // Validate department
                                if (!currentSite.departments.includes(row['Department'])) {
                                    throw new Error(`Invalid department. Valid departments: ${currentSite.departments.join(', ')}`);
                                }
                                
                                // Validate status
                                const status = row['Status'] || 'active';
                                if (!['active', 'failed', 'replaced'].includes(status.toLowerCase())) {
                                    throw new Error("Status must be 'active', 'failed', or 'replaced'");
                                }
                                
                                // Prepare device data
                                const deviceData = {
                                    pcNumber: String(row['PC Number']).trim(),
                                    pcModel: String(row['PC Model']).trim(),
                                    pcSerial: String(row['PC Serial']).trim(),
                                    department: String(row['Department']).trim(),
                                    userName: row['User Name'] ? String(row['User Name']).trim() : '',
                                    cpu: row['CPU'] ? String(row['CPU']).trim() : '',
                                    gpu: row['GPU'] ? String(row['GPU']).trim() : '',
                                    ram: row['RAM'] ? String(row['RAM']).trim() : '',
                                    storage: row['Storage'] ? String(row['Storage']).trim() : '',
                                    monitorModel: row['Monitor Model'] ? String(row['Monitor Model']).trim() : '',
                                    monitorSerial: row['Monitor Serial'] ? String(row['Monitor Serial']).trim() : '',
                                    status: status.toLowerCase(),
                                    networkInterfaces: [],
                                    softwareLicenses: [],
                                    createdBy: currentUser,
                                    site: currentSite.name
                                };
                                
                                // Save to Firebase
                                await saveDeviceToFirebase(deviceData);
                                results.success++;
                                
                            } catch (error) {
                                results.failed++;
                                results.errors.push(`Row ${rowNum}: ${error.message}`);
                            }
                            
                            // Update progress
                            const progress = Math.round(((i + 1) / jsonData.length) * 100);
                            updateImportProgress(progress, i + 1, jsonData.length);
                        }
                        
                        resolve(results);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error("Error reading file"));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        function updateImportProgress(percent, current, total) {
            const progressBar = document.getElementById('importProgressBar');
            const progressText = document.getElementById('importProgressText');
            
            if (progressBar && progressText) {
                progressBar.style.width = percent + '%';
                progressText.textContent = `Processing ${current} of ${total} devices...`;
            }
        }

        // ============================================
        // SOFTWARE LICENSE MANAGEMENT
        // ============================================
        function createSoftwareLicenseElement(softwareData = null, index = 0) {
            const softwareId = softwareData?.id || `software-${Date.now()}-${index}`;
            const softwareName = softwareData?.name || `Software ${index + 1}`;
            
            const div = document.createElement('div');
            div.className = 'software-license';
            div.innerHTML = `
                <div class="software-license-header">
                    <h4><i class="fas fa-copyright"></i> ${softwareName}</h4>
                    <button type="button" class="remove-software-btn" onclick="removeSoftwareLicense('${softwareId}')">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-file-signature"></i> Software Name *</label>
                        <input type="text" class="software-name form-field" value="${softwareName}" 
                               placeholder="e.g., Microsoft Office 2021" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-key"></i> License Key</label>
                        <input type="text" class="software-license-key form-field" value="${softwareData?.licenseKey || ''}" 
                               placeholder="Enter license key">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> Expiry Date</label>
                        <input type="date" class="software-expiry form-field" value="${softwareData?.expiryDate || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user-tie"></i> Licensed To</label>
                        <input type="text" class="software-licensed-to form-field" value="${softwareData?.licensedTo || ''}" 
                               placeholder="Name of license holder">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-info-circle"></i> Version</label>
                        <input type="text" class="software-version form-field" value="${softwareData?.version || ''}" 
                               placeholder="e.g., 2021, v2.0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Notes</label>
                        <textarea class="software-notes form-field" rows="2" placeholder="Any additional notes">${softwareData?.notes || ''}</textarea>
                    </div>
                </div>
                <input type="hidden" class="software-id" value="${softwareId}">
            `;
            
            return div;
        }

        function removeSoftwareLicense(softwareId) {
            const softwareDiv = document.querySelector(`.software-license input.software-id[value="${softwareId}"]`)?.closest('.software-license');
            if (softwareDiv) {
                softwareDiv.remove();
                updateAllSoftwareTitles();
            }
        }

        function updateAllSoftwareTitles() {
            document.querySelectorAll('.software-license').forEach((softwareDiv, index) => {
                const header = softwareDiv.querySelector('.software-license-header h4');
                const nameInput = softwareDiv.querySelector('.software-name');
                header.innerHTML = `<i class="fas fa-copyright"></i> ${nameInput.value || `Software ${index + 1}`}`;
            });
        }

        function collectSoftwareLicensesData() {
            const softwareLicenses = [];
            document.querySelectorAll('.software-license').forEach(softwareDiv => {
                const softwareData = {
                    id: softwareDiv.querySelector('.software-id').value,
                    name: softwareDiv.querySelector('.software-name').value || 'Unnamed Software',
                    licenseKey: softwareDiv.querySelector('.software-license-key').value,
                    expiryDate: softwareDiv.querySelector('.software-expiry').value,
                    licensedTo: softwareDiv.querySelector('.software-licensed-to').value,
                    version: softwareDiv.querySelector('.software-version').value,
                    notes: softwareDiv.querySelector('.software-notes').value
                };
                
                if (softwareData.name) {
                    softwareLicenses.push(softwareData);
                }
            });
            return softwareLicenses;
        }

        // ============================================
        // NETWORK INTERFACES MANAGEMENT
        // ============================================
        function createNetworkInterfaceElement(interfaceData = null, index = 0) {
            const interfaceId = interfaceData?.id || `network-${Date.now()}-${index}`;
            const interfaceName = interfaceData?.interfaceName || `Interface ${index + 1}`;
            
            const div = document.createElement('div');
            div.className = 'network-interface';
            div.innerHTML = `
                <div class="network-interface-header">
                    <h4><i class="fas fa-network-wired"></i> ${interfaceName}</h4>
                    <button type="button" class="remove-network-btn" onclick="removeNetworkInterface('${interfaceId}')">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-ethernet"></i> Interface Name</label>
                        <input type="text" class="interface-name form-field" value="${interfaceName}" 
                               placeholder="e.g., Ethernet, WiFi, LAN" 
                               onchange="updateInterfaceTitle(this, '${interfaceId}')">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-network-wired"></i> IP Address</label>
                        <input type="text" class="interface-ip form-field" value="${interfaceData?.ipAddress || ''}" 
                               placeholder="e.g., 192.168.1.10">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-shield-alt"></i> Subnet Mask</label>
                        <input type="text" class="interface-subnet form-field" value="${interfaceData?.subnetMask || ''}" 
                               placeholder="e.g., 255.255.255.0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-route"></i> Default Gateway</label>
                        <input type="text" class="interface-gateway form-field" value="${interfaceData?.gateway || ''}" 
                               placeholder="e.g., 192.168.1.1">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-server"></i> DNS Servers</label>
                        <input type="text" class="interface-dns form-field" value="${interfaceData?.dns || ''}" 
                               placeholder="e.g., 8.8.8.8, 8.8.4.4">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sitemap"></i> MAC Address</label>
                        <input type="text" class="interface-mac form-field" value="${interfaceData?.macAddress || ''}" 
                               placeholder="e.g., 00:1A:2B:3C:4D:5E">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-plug"></i> Connection Type</label>
                        <select class="interface-type form-field">
                            <option value="ethernet" ${interfaceData?.type === 'ethernet' ? 'selected' : ''}>Ethernet</option>
                            <option value="wifi" ${interfaceData?.type === 'wifi' ? 'selected' : ''}>WiFi</option>
                            <option value="fiber" ${interfaceData?.type === 'fiber' ? 'selected' : ''}>Fiber</option>
                            <option value="other" ${interfaceData?.type === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" class="interface-id" value="${interfaceId}">
            `;
            
            return div;
        }

        function updateInterfaceTitle(input, interfaceId) {
            const interfaceDiv = input.closest('.network-interface');
            const header = interfaceDiv.querySelector('.network-interface-header h4');
            header.innerHTML = `<i class="fas fa-network-wired"></i> ${input.value}`;
        }

        function removeNetworkInterface(interfaceId) {
            const interfaceDiv = document.querySelector(`.network-interface input.interface-id[value="${interfaceId}"]`)?.closest('.network-interface');
            if (interfaceDiv) {
                interfaceDiv.remove();
                updateAllInterfaceTitles();
            }
        }

        function updateAllInterfaceTitles() {
            document.querySelectorAll('.network-interface').forEach((interfaceDiv, index) => {
                const header = interfaceDiv.querySelector('.network-interface-header h4');
                const nameInput = interfaceDiv.querySelector('.interface-name');
                header.innerHTML = `<i class="fas fa-network-wired"></i> ${nameInput.value || `Interface ${index + 1}`}`;
            });
        }

        function collectNetworkInterfacesData() {
            const interfaces = [];
            document.querySelectorAll('.network-interface').forEach(interfaceDiv => {
                const interfaceData = {
                    id: interfaceDiv.querySelector('.interface-id').value,
                    interfaceName: interfaceDiv.querySelector('.interface-name').value || 'Unnamed Interface',
                    ipAddress: interfaceDiv.querySelector('.interface-ip').value,
                    subnetMask: interfaceDiv.querySelector('.interface-subnet').value,
                    gateway: interfaceDiv.querySelector('.interface-gateway').value,
                    dns: interfaceDiv.querySelector('.interface-dns').value,
                    macAddress: interfaceDiv.querySelector('.interface-mac').value,
                    type: interfaceDiv.querySelector('.interface-type').value
                };
                
                if (interfaceData.ipAddress) {
                    interfaces.push(interfaceData);
                }
            });
            return interfaces;
        }

        // ============================================
        // SAMPLE LOGS FOR TESTING
        // ============================================
        function getSampleLogs() {
            const sriLankaTime = getSriLankaTime();
            const sampleLogs = [
                {
                    id: 'sample-1',
                    timestamp: formatSriLankaTimestamp(sriLankaTime),
                    action: 'Login',
                    details: `${currentUser} logged into the ${currentSite.name} system`,
                    user: currentUser,
                    site: currentSite.name
                },
                {
                    id: 'sample-2',
                    timestamp: formatSriLankaTimestamp(new Date(sriLankaTime.getTime() - 3600000)),
                    action: 'Device Added',
                    details: 'Added PC-001 (Dell OptiPlex 7080)',
                    user: currentUser,
                    site: currentSite.name
                }
            ];
            
            console.log(" Using sample logs for display");
            return sampleLogs;
        }

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loginPage = document.getElementById('loginPage');
        const siteSelectionPage = document.getElementById('siteSelectionPage');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const switchSiteBtn = document.getElementById('switchSiteBtn');
        const loginError = document.getElementById('loginError');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const wtcCard = document.getElementById('wtcCard');
        const hlsCard = document.getElementById('hlsCard');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const siteTitle = document.getElementById('siteTitle');
        const networkDiagramUrl = document.getElementById('networkDiagramUrl');
        
        // Navigation
        const sidebarItems = document.querySelectorAll('.sidebar-menu li');
        const sections = document.querySelectorAll('.section');
        
        // Inventory elements
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const searchBox = document.getElementById('searchBox');
        const departmentFilter = document.getElementById('departmentFilter');
        const addNewBtn = document.getElementById('addNewBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const noDataMessage = document.getElementById('noDataMessage');
        const exportBtn = document.getElementById('exportBtn');
        
        // Stats cards
        const totalDevicesCard = document.getElementById('totalDevicesCard');
        const activeDevicesCard = document.getElementById('activeDevicesCard');
        const failedDevicesCard = document.getElementById('failedDevicesCard');
        const replacedDevicesCard = document.getElementById('replacedDevicesCard');
        
        // Network interfaces
        const networkInterfacesList = document.getElementById('networkInterfacesList');
        const addNetworkInterfaceBtn = document.getElementById('addNetworkInterfaceBtn');
        
        // Software licenses
        const softwareLicensesList = document.getElementById('softwareLicensesList');
        const addSoftwareLicenseBtn = document.getElementById('addSoftwareLicenseBtn');
        
        // Failed devices elements
        const failedDevicesTableBody = document.getElementById('failedDevicesTableBody');
        const failedSearchBox = document.getElementById('failedSearchBox');
        const failedPriorityFilter = document.getElementById('failedPriorityFilter');
        const refreshFailedBtn = document.getElementById('refreshFailedBtn');
        const noFailedDataMessage = document.getElementById('noFailedDataMessage');
        
        // Form elements
        const deviceForm = document.getElementById('deviceForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveDeviceBtn = document.getElementById('saveDeviceBtn');
        
        // Report Failure
        const failureReportForm = document.getElementById('failureReportForm');
        const failureDevice = document.getElementById('failureDevice');
        const reportFailureBtn = document.getElementById('reportFailureBtn');
        const cancelFailureBtn = document.getElementById('cancelFailureBtn');
        const reportedBySelect = document.getElementById('reportedBy');
        
        // Replace Device
        const replaceDeviceForm = document.getElementById('replaceDeviceForm');
        const replaceDeviceSelect = document.getElementById('replaceDeviceSelect');
        const replaceDeviceBtn = document.getElementById('replaceDeviceBtn');
        const cancelReplaceFormBtn = document.getElementById('cancelReplaceFormBtn');
        const replacedBySelect = document.getElementById('replacedBy');
        
        // Excel Import/Export
        const exportAllBtn = document.getElementById('exportAllBtn');
        const exportActiveBtn = document.getElementById('exportActiveBtn');
        const exportFailedBtn = document.getElementById('exportFailedBtn');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const excelFileInput = document.getElementById('excelFileInput');
        const importBtn = document.getElementById('importBtn');
        const exportLogsBtn = document.getElementById('exportLogsBtn');
        
        // Logs
        const logsContainer = document.getElementById('logsContainer');
        const logSearchBox = document.getElementById('logSearchBox');
        const logTypeFilter = document.getElementById('logTypeFilter');
        const refreshLogsBtn = document.getElementById('refreshLogsBtn');
        
        // Modals
        const deviceDetailsModal = document.getElementById('deviceDetailsModal');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const markFixedModal = document.getElementById('markFixedModal');
        const closeMarkFixedModal = document.getElementById('closeMarkFixedModal');
        const repairHistoryModal = document.getElementById('repairHistoryModal');
        const closeRepairHistoryModal = document.getElementById('closeRepairHistoryModal');
        
        // Network diagram
        const viewDiagramBtn = document.getElementById('viewDiagramBtn');
        
        // Stats
        const totalDevicesElement = document.getElementById('totalDevices');
        const activeDevicesElement = document.getElementById('activeDevices');
        const failedDevicesElement = document.getElementById('failedDevices');
        const replacedDevicesElement = document.getElementById('replacedDevices');

        // ============================================
        // LOGIN FUNCTIONALITY - FIXED
        // ============================================
        loginBtn.addEventListener('click', async function() {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            const originalButtonText = loginBtn.innerHTML;
            const originalButtonState = loginBtn.disabled;
            
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
            loginBtn.disabled = true;
            
            // Simulate authentication delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Check credentials (username: Adithya, password: root@1690#)
            if (username === 'Adithya' && password === 'root@1690#') {
                currentUser = username;
                document.getElementById('currentUserName').textContent = username;
                
                loginPage.style.animation = 'slideOut 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                
                setTimeout(() => {
                    loginPage.style.display = 'none';
                    siteSelectionPage.style.display = 'flex';
                    siteSelectionPage.style.animation = 'slideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                    
                    loginError.style.display = 'none';
                    usernameInput.style.borderColor = "#D1DDDE";
                    passwordInput.style.borderColor = "#D1DDDE";
                }, 800);
            } else {
                loginError.style.display = 'block';
                usernameInput.style.borderColor = "#DC3545";
                passwordInput.style.borderColor = "#DC3545";
                
                loginBox.style.animation = 'none';
                setTimeout(() => {
                    loginBox.style.animation = 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both';
                }, 10);
            }
            
            // Reset button state regardless of success/failure
            loginBtn.innerHTML = originalButtonText;
            loginBtn.disabled = originalButtonState;
        });

        // Add shake animation for failed login
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                10%, 90% { transform: translate3d(-1px, 0, 0); }
                20%, 80% { transform: translate3d(2px, 0, 0); }
                30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
                40%, 60% { transform: translate3d(3px, 0, 0); }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // SITE SELECTION
        // ============================================
        wtcCard.addEventListener('click', function() {
            selectSite('wtc');
        });

        hlsCard.addEventListener('click', function() {
            selectSite('hls');
        });

        backToLoginBtn.addEventListener('click', function() {
            siteSelectionPage.style.animation = 'slideOut 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            
            setTimeout(() => {
                siteSelectionPage.style.display = 'none';
                loginPage.style.display = 'flex';
                loginPage.style.animation = 'slideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                usernameInput.value = '';
                passwordInput.value = '';
                usernameInput.focus();
            }, 800);
        });

        switchSiteBtn.addEventListener('click', function() {
            appContainer.style.animation = 'slideOut 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            
            setTimeout(() => {
                appContainer.style.display = 'none';
                siteSelectionPage.style.display = 'flex';
                siteSelectionPage.style.animation = 'slideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                if (realTimeUnsubscribe) {
                    realTimeUnsubscribe();
                }
                if (logsUnsubscribe) {
                    logsUnsubscribe();
                }
                
                currentSite = null;
                inventoryData = [];
                activityLogs = [];
                
            }, 800);
        });

        function selectSite(siteName) {
            currentSite = siteConfig[siteName];
            
            // Update UI for selected site
            siteTitle.textContent = `${currentSite.name} - IT Management Interface`;
            networkDiagramUrl.textContent = currentSite.networkDiagram;
            
            // Update department dropdowns
            updateDepartmentDropdowns();
            
            // Update technician dropdowns
            updateTechnicianDropdowns();
            
            siteSelectionPage.style.animation = 'slideOut 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            
            setTimeout(() => {
                siteSelectionPage.style.display = 'none';
                appContainer.style.display = 'block';
                appContainer.style.animation = 'slideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                addLogEntry('Login', `${currentUser} logged into ${currentSite.name} system`);
                loadInventoryFromFirebase();
                loadLogsFromFirebase();
                
                startRealTimeUpdates();
                startRealTimeLogs();
                
                updateFailureDeviceDropdown();
                updateReplaceDeviceDropdown();
                
                addDefaultNetworkInterface();
                addDefaultSoftwareLicense();
                
                setupEnterKeyNavigation();
            }, 800);
        }

        function updateDepartmentDropdowns() {
            if (!currentSite) return;
            
            // Update main department filter
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            currentSite.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });
            
            // Update add device department dropdown
            const addDeviceDept = document.getElementById('department');
            addDeviceDept.innerHTML = '<option value="">Select Department</option>';
            currentSite.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                addDeviceDept.appendChild(option);
            });
        }

        function updateTechnicianDropdowns() {
            if (!currentSite) return;
            
            // Update reported by dropdown
            reportedBySelect.innerHTML = '<option value="">Select Technician</option>';
            currentSite.technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                reportedBySelect.appendChild(option);
            });
            
            // Update replaced by dropdown
            replacedBySelect.innerHTML = '<option value="">Select Technician</option>';
            currentSite.technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                replacedBySelect.appendChild(option);
            });
        }

        // ============================================
        // EXCEL IMPORT/EXPORT EVENT HANDLERS
        // ============================================
        exportBtn.addEventListener('click', function() {
            if (!inventoryData || inventoryData.length === 0) {
                alert("No data to export");
                return;
            }
            
            exportToExcel(inventoryData, 'All_Devices');
            addLogEntry('Excel Export', `Exported all devices (${inventoryData.length} records) to Excel`);
        });

        exportAllBtn.addEventListener('click', function() {
            if (!inventoryData || inventoryData.length === 0) {
                alert("No data to export");
                return;
            }
            
            exportToExcel(inventoryData, 'All_Devices');
            addLogEntry('Excel Export', `Exported all devices (${inventoryData.length} records) to Excel`);
        });

        exportActiveBtn.addEventListener('click', function() {
            const activeDevices = inventoryData.filter(device => device.status === 'active');
            if (activeDevices.length === 0) {
                alert("No active devices to export");
                return;
            }
            
            exportToExcel(activeDevices, 'Active_Devices');
            addLogEntry('Excel Export', `Exported active devices (${activeDevices.length} records) to Excel`);
        });

        exportFailedBtn.addEventListener('click', function() {
            const failedDevices = inventoryData.filter(device => device.status === 'failed');
            if (failedDevices.length === 0) {
                alert("No failed devices to export");
                return;
            }
            
            exportToExcel(failedDevices, 'Failed_Devices');
            addLogEntry('Excel Export', `Exported failed devices (${failedDevices.length} records) to Excel`);
        });

        downloadTemplateBtn.addEventListener('click', function() {
            downloadTemplate();
            addLogEntry('Template Download', 'Downloaded Excel import template');
        });

        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importBtn.disabled = false;
                importBtn.innerHTML = `<i class="fas fa-upload"></i> Import Devices (${file.name})`;
            }
        });

        importBtn.addEventListener('click', async function() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert("Please select an Excel file first");
                return;
            }

            // Check file extension
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert("Please select an Excel file (.xlsx or .xls)");
                return;
            }

            // Show progress
            const importProgress = document.getElementById('importProgress');
            const importResults = document.getElementById('importResults');
            importProgress.style.display = 'block';
            importResults.innerHTML = '';

            // Reset progress bar
            updateImportProgress(0, 0, 0);

            try {
                // Import data
                const results = await importFromExcel(file);
                
                // Show results
                importResults.innerHTML = `
                    <div style="padding: 15px; background: var(--secondary-light); border-radius: 8px; border: 1px solid var(--border-color);">
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> Import Complete
                        </h4>
                        <p>Total devices processed: <strong>${results.total}</strong></p>
                        <p>Successfully imported: <strong style="color: var(--success-color);">${results.success}</strong></p>
                        <p>Failed: <strong style="color: var(--danger-color);">${results.failed}</strong></p>
                        ${results.errors.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p><strong>Errors:</strong></p>
                                <div style="max-height: 150px; overflow-y: auto; background: var(--primary-white); padding: 10px; border-radius: 4px; font-size: 12px;">
                                    ${results.errors.map(error => `<div style="color: var(--danger-color); margin-bottom: 5px;">${error}</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Log the import
                addLogEntry('Excel Import', `Imported ${results.success} devices from Excel (${results.failed} failed)`);

                // Refresh inventory
                setTimeout(() => {
                    loadInventoryFromFirebase();
                    importBtn.disabled = true;
                    importBtn.innerHTML = `<i class="fas fa-upload"></i> Import Devices`;
                    excelFileInput.value = '';
                }, 2000);

            } catch (error) {
                console.error("Import error:", error);
                importResults.innerHTML = `
                    <div style="padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid var(--danger-color); color: var(--danger-color);">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-exclamation-circle"></i> Import Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        exportLogsBtn.addEventListener('click', function() {
            if (!activityLogs || activityLogs.length === 0) {
                alert("No logs to export");
                return;
            }

            try {
                // Prepare logs for Excel
                const excelData = activityLogs.map(log => ({
                    'Timestamp': log.timestamp || 'N/A',
                    'Action': log.action || 'N/A',
                    'Details': log.details || 'N/A',
                    'User': log.user || 'N/A',
                    'Site': log.site || 'N/A'
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                const wscols = [
                    { wch: 20 }, // Timestamp
                    { wch: 25 }, // Action
                    { wch: 40 }, // Details
                    { wch: 15 }, // User
                    { wch: 10 }  // Site
                ];
                ws['!cols'] = wscols;

                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Activity Logs');
                
                // Generate filename
                const dateStr = new Date().toISOString().split('T')[0];
                const exportFilename = `Activity_Logs_${currentSite.name}_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, exportFilename);
                
                addLogEntry('Excel Export', `Exported activity logs (${activityLogs.length} records) to Excel`);
                
            } catch (error) {
                console.error("Error exporting logs to Excel:", error);
                alert("Error exporting logs to Excel: " + error.message);
            }
        });

        // ============================================
        // ENTER KEY NAVIGATION
        // ============================================
        function setupEnterKeyNavigation() {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    const activeElement = document.activeElement;
                    
                    if (activeElement.classList.contains('form-field')) {
                        e.preventDefault();
                        
                        const formFields = Array.from(document.querySelectorAll('.form-field'));
                        const currentIndex = formFields.indexOf(activeElement);
                        
                        if (currentIndex !== -1 && currentIndex < formFields.length - 1) {
                            const nextField = formFields[currentIndex + 1];
                            nextField.focus();
                            
                            if (nextField.tagName === 'SELECT') {
                                nextField.click();
                            }
                        } else if (currentIndex === formFields.length - 1) {
                            const form = activeElement.closest('form');
                            if (form) {
                                const submitBtn = form.querySelector('button[type="submit"]');
                                if (submitBtn) {
                                    submitBtn.click();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // NETWORK INTERFACES INITIALIZATION
        // ============================================
        function addDefaultNetworkInterface() {
            networkInterfacesList.innerHTML = '';
            const defaultInterface = createNetworkInterfaceElement({
                id: 'default-interface',
                interfaceName: 'Primary Interface',
                ipAddress: '',
                subnetMask: '255.255.255.0',
                gateway: '',
                type: 'ethernet'
            }, 0);
            networkInterfacesList.appendChild(defaultInterface);
        }

        addNetworkInterfaceBtn.addEventListener('click', function() {
            const interfaceCount = document.querySelectorAll('.network-interface').length;
            const newInterface = createNetworkInterfaceElement(null, interfaceCount);
            networkInterfacesList.appendChild(newInterface);
            
            newInterface.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

        // ============================================
        // SOFTWARE LICENSES INITIALIZATION
        // ============================================
        function addDefaultSoftwareLicense() {
            softwareLicensesList.innerHTML = '';
            const defaultSoftware = createSoftwareLicenseElement({
                id: 'default-software',
                name: 'Operating System'
            }, 0);
            softwareLicensesList.appendChild(defaultSoftware);
        }

        addSoftwareLicenseBtn.addEventListener('click', function() {
            const softwareCount = document.querySelectorAll('.software-license').length;
            const newSoftware = createSoftwareLicenseElement(null, softwareCount);
            softwareLicensesList.appendChild(newSoftware);
            
            newSoftware.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

        // ============================================
        // REAL-TIME UPDATES
        // ============================================
        function startRealTimeUpdates() {
            if (realTimeUnsubscribe) {
                realTimeUnsubscribe();
            }
            
            if (!currentSite) return;
            
            realTimeUnsubscribe = db.collection(currentSite.firebaseCollection)
                .onSnapshot((snapshot) => {
                    console.log(" Real-time update received for", currentSite.name);
                    const updatedDevices = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        updatedDevices.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    inventoryData = updatedDevices;
                    
                    loadInventoryTable();
                    updateStats();
                    
                    if (document.getElementById('failedDevices').classList.contains('active')) {
                        loadFailedDevicesTable();
                    }
                    
                    updateFailureDeviceDropdown();
                    updateReplaceDeviceDropdown();
                    
                }, (error) => {
                    console.error("Real-time update error:", error);
                });
        }

        function startRealTimeLogs() {
            if (logsUnsubscribe) {
                logsUnsubscribe();
            }
            
            if (!currentSite) return;
            
            logsUnsubscribe = db.collection(currentSite.logsCollection)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    const updatedLogs = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        let timestamp = data.sriLankaTimestamp || data.timestamp || formatSriLankaTimestamp(getSriLankaTime());
                        
                        if (timestamp && timestamp.toDate) {
                            try {
                                const date = timestamp.toDate();
                                timestamp = formatSriLankaTimestamp(date);
                            } catch (e) {
                                console.error("Error converting timestamp:", e);
                            }
                        }
                        
                        updatedLogs.push({
                            id: doc.id,
                            timestamp: timestamp,
                            action: data.action || 'Unknown Action',
                            details: data.details || '',
                            user: data.user || 'System',
                            site: data.site || currentSite.name
                        });
                    });
                    
                    activityLogs = updatedLogs;
                    
                    if (document.getElementById('logs').classList.contains('active')) {
                        loadLogs();
                    }
                    
                    console.log(" Real-time logs updated for", currentSite.name);
                }, (error) => {
                    console.error("Real-time logs error:", error);
                });
        }

        // ============================================
        // STATS CARDS CLICK HANDLERS
        // ============================================
        totalDevicesCard.addEventListener('click', function() {
            departmentFilter.value = '';
            searchBox.value = '';
            loadInventoryTable();
            scrollToTop();
        });

        activeDevicesCard.addEventListener('click', function() {
            departmentFilter.value = '';
            searchBox.value = '';
            const filteredData = inventoryData.filter(device => device.status === 'active');
            loadFilteredTable(filteredData, 'Active Devices');
            scrollToTop();
        });

        failedDevicesCard.addEventListener('click', function() {
            departmentFilter.value = '';
            searchBox.value = '';
            const filteredData = inventoryData.filter(device => device.status === 'failed');
            loadFilteredTable(filteredData, 'Failed Devices');
            scrollToTop();
        });

        replacedDevicesCard.addEventListener('click', function() {
            departmentFilter.value = '';
            searchBox.value = '';
            const filteredData = inventoryData.filter(device => device.status === 'replaced');
            loadFilteredTable(filteredData, 'Replaced Devices');
            scrollToTop();
        });

        function loadFilteredTable(filteredData, title) {
            inventoryTableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                noDataMessage.style.display = 'block';
                noDataMessage.innerHTML = `
                    <i class="fas fa-laptop" style="font-size: 60px; color: var(--border-color); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--text-gray); margin-bottom: 10px;">No ${title} Found</h3>
                `;
                return;
            } else {
                noDataMessage.style.display = 'none';
            }
            
            filteredData.forEach(device => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', device.id);
                row.classList.add('device-row');
                
                let primaryIP = 'N/A';
                if (device.networkInterfaces && device.networkInterfaces.length > 0) {
                    primaryIP = device.networkInterfaces[0].ipAddress || 'N/A';
                } else if (device.ipAddress) {
                    primaryIP = device.ipAddress;
                }
                
                let statusBadge = '';
                if (device.status === 'active') {
                    statusBadge = '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>';
                } else if (device.status === 'failed') {
                    statusBadge = '<span class="status-badge status-failed"><i class="fas fa-exclamation-triangle"></i> Failed</span>';
                } else if (device.status === 'replaced') {
                    statusBadge = '<span class="status-badge status-replaced"><i class="fas fa-exchange-alt"></i> Replaced</span>';
                } else if (device.status === 'fixed') {
                    statusBadge = '<span class="status-badge status-fixed"><i class="fas fa-wrench"></i> Fixed</span>';
                }
                
                const interfaceCount = device.networkInterfaces ? device.networkInterfaces.length : 0;
                const ipInfo = `
                    <strong>${primaryIP}</strong>
                    <div style="font-size: 12px; color: var(--text-gray);">
                        <div>Interfaces: ${interfaceCount}</div>
                        ${device.networkInterfaces && device.networkInterfaces.length > 1 ? 
                         '<div style="color: var(--accent-color);">+' + (interfaceCount - 1) + ' more</div>' : ''}
                    </div>
                `;
                
                row.innerHTML = `
                    <td><strong>${device.pcNumber || 'N/A'}</strong></td>
                    <td>${device.pcModel || 'N/A'}</td>
                    <td>${ipInfo}</td>
                    <td><span class="status-badge" style="background: rgba(0, 49, 53, 0.1); color: var(--primary-color);">${device.department || 'N/A'}</span></td>
                    <td>${device.userName || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm view-btn" data-id="${device.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm edit-btn" data-id="${device.id}" title="Edit Device">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${device.id}" title="Delete Device">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                inventoryTableBody.appendChild(row);
            });
            
            attachActionButtonListeners();
            attachRowClickListeners();
            
            const tableHeader = document.querySelector('#inventory h2');
            const originalTitle = '<i class="fas fa-laptop"></i> Device Inventory Dashboard';
            tableHeader.innerHTML = `<i class="fas fa-filter"></i> ${title} (${filteredData.length} devices)`;
            
            const actionsBar = document.querySelector('.actions-bar');
            if (!document.querySelector('#backToAllBtn')) {
                const backBtn = document.createElement('button');
                backBtn.className = 'btn btn-info';
                backBtn.id = 'backToAllBtn';
                backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back to All Devices';
                backBtn.addEventListener('click', function() {
                    tableHeader.innerHTML = originalTitle;
                    backBtn.remove();
                    loadInventoryTable();
                });
                actionsBar.querySelector('.action-buttons').prepend(backBtn);
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // LOGOUT FUNCTIONALITY
        // ============================================
        logoutBtn.addEventListener('click', async function() {
            await addLogEntry('Logout', `${currentUser} logged out from ${currentSite.name}`);
            
            if (realTimeUnsubscribe) {
                realTimeUnsubscribe();
            }
            if (logsUnsubscribe) {
                logsUnsubscribe();
            }
            
            appContainer.style.animation = 'slideOut 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            
            setTimeout(() => {
                appContainer.style.display = 'none';
                loginPage.style.display = 'flex';
                loginPage.style.animation = 'slideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                usernameInput.value = '';
                passwordInput.value = '';
                loginError.style.display = 'none';
                
                currentSite = null;
                inventoryData = [];
                activityLogs = [];
                inventoryTableBody.innerHTML = '';
                logsContainer.innerHTML = '';
                
                usernameInput.focus();
            }, 800);
        });

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadInventoryFromFirebase() {
            try {
                inventoryData = await loadDevicesFromFirebase();
                loadInventoryTable();
                loadFailedDevicesTable();
                updateStats();
            } catch (error) {
                console.error("Error loading inventory:", error);
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        sidebarItems.forEach(item => {
            item.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                
                sidebarItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === sectionId) {
                        section.classList.add('active');
                    }
                });
                
                if (sectionId === 'inventory') {
                    loadInventoryTable();
                } else if (sectionId === 'logs') {
                    loadLogs();
                } else if (sectionId === 'failedDevices') {
                    loadFailedDevicesTable();
                } else if (sectionId === 'networkDiagram') {
                    networkDiagramUrl.textContent = currentSite.networkDiagram;
                } else if (sectionId === 'excelImport') {
                    // Reset import form
                    importBtn.disabled = true;
                    importBtn.innerHTML = `<i class="fas fa-upload"></i> Import Devices`;
                    excelFileInput.value = '';
                    document.getElementById('importProgress').style.display = 'none';
                }
            });
        });

        // ============================================
        // INVENTORY TABLE
        // ============================================
        function loadInventoryTable() {
            const searchTerm = searchBox.value.toLowerCase();
            const department = departmentFilter.value;
            
            let filteredData = inventoryData.filter(device => {
                const matchesSearch = 
                    (device.pcNumber && device.pcNumber.toLowerCase().includes(searchTerm)) || 
                    (device.pcSerial && device.pcSerial.toLowerCase().includes(searchTerm)) ||
                    (device.userName && device.userName.toLowerCase().includes(searchTerm));
                
                const matchesDepartment = !department || device.department === department;
                
                return matchesSearch && matchesDepartment;
            });
            
            inventoryTableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            } else {
                noDataMessage.style.display = 'none';
            }
            
            filteredData.forEach(device => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', device.id);
                row.classList.add('device-row');
                
                let primaryIP = 'N/A';
                if (device.networkInterfaces && device.networkInterfaces.length > 0) {
                    primaryIP = device.networkInterfaces[0].ipAddress || 'N/A';
                } else if (device.ipAddress) {
                    primaryIP = device.ipAddress;
                }
                
                let statusBadge = '';
                if (device.status === 'active') {
                    statusBadge = '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>';
                } else if (device.status === 'failed') {
                    statusBadge = '<span class="status-badge status-failed"><i class="fas fa-exclamation-triangle"></i> Failed</span>';
                } else if (device.status === 'replaced') {
                    statusBadge = '<span class="status-badge status-replaced"><i class="fas fa-exchange-alt"></i> Replaced</span>';
                } else if (device.status === 'fixed') {
                    statusBadge = '<span class="status-badge status-fixed"><i class="fas fa-wrench"></i> Fixed</span>';
                }
                
                const interfaceCount = device.networkInterfaces ? device.networkInterfaces.length : 0;
                const ipInfo = `
                    <strong>${primaryIP}</strong>
                    <div style="font-size: 12px; color: var(--text-gray);">
                        <div>Interfaces: ${interfaceCount}</div>
                        ${device.networkInterfaces && device.networkInterfaces.length > 1 ? 
                         '<div style="color: var(--accent-color);">+' + (interfaceCount - 1) + ' more</div>' : ''}
                    </div>
                `;
                
                row.innerHTML = `
                    <td><strong>${device.pcNumber || 'N/A'}</strong></td>
                    <td>${device.pcModel || 'N/A'}</td>
                    <td>${ipInfo}</td>
                    <td><span class="status-badge" style="background: rgba(0, 49, 53, 0.1); color: var(--primary-color);">${device.department || 'N/A'}</span></td>
                    <td>${device.userName || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm view-btn" data-id="${device.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm edit-btn" data-id="${device.id}" title="Edit Device">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${device.id}" title="Delete Device">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                inventoryTableBody.appendChild(row);
            });
            
            attachActionButtonListeners();
            attachRowClickListeners();
            updateStats();
            
            const tableHeader = document.querySelector('#inventory h2');
            const originalTitle = '<i class="fas fa-laptop"></i> Device Inventory Dashboard';
            if (!tableHeader.innerHTML.includes('Device Inventory Dashboard')) {
                tableHeader.innerHTML = originalTitle;
            }
            
            const backBtn = document.querySelector('#backToAllBtn');
            if (backBtn) {
                backBtn.remove();
            }
        }

        function attachRowClickListeners() {
            document.querySelectorAll('.device-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (e.target.closest('button')) return;
                    
                    const deviceId = this.getAttribute('data-id');
                    showDeviceDetails(deviceId);
                });
            });
        }

        // ============================================
        // FAILED DEVICES TABLE
        // ============================================
        function loadFailedDevicesTable() {
            const searchTerm = failedSearchBox.value.toLowerCase();
            const priority = failedPriorityFilter.value;
            
            let failedDevices = inventoryData.filter(device => {
                if (device.status !== 'failed') return false;
                
                const matchesSearch = 
                    (device.pcNumber && device.pcNumber.toLowerCase().includes(searchTerm)) || 
                    (device.pcModel && device.pcModel.toLowerCase().includes(searchTerm)) ||
                    (device.userName && device.userName.toLowerCase().includes(searchTerm));
                
                const matchesPriority = !priority || (device.failureReport && device.failureReport.priority === priority);
                
                return matchesSearch && matchesPriority;
            });
            
            failedDevicesTableBody.innerHTML = '';
            
            if (failedDevices.length === 0) {
                noFailedDataMessage.style.display = 'block';
                return;
            } else {
                noFailedDataMessage.style.display = 'none';
            }
            
            failedDevices.forEach(device => {
                const row = document.createElement('tr');
                
                let priorityBadge = '';
                const priority = device.failureReport?.priority || 'medium';
                if (priority === 'low') {
                    priorityBadge = '<span class="status-badge" style="background: rgba(40, 167, 69, 0.1); color: var(--success-color);">Low</span>';
                } else if (priority === 'medium') {
                    priorityBadge = '<span class="status-badge" style="background: rgba(255, 193, 7, 0.1); color: var(--warning-color);">Medium</span>';
                } else if (priority === 'high') {
                    priorityBadge = '<span class="status-badge" style="background: rgba(220, 53, 69, 0.1); color: var(--danger-color);">High</span>';
                } else if (priority === 'critical') {
                    priorityBadge = '<span class="status-badge" style="background: rgba(111, 66, 193, 0.1); color: #6f42c1;">Critical</span>';
                }
                
                row.innerHTML = `
                    <td><strong>${device.pcNumber || 'N/A'}</strong></td>
                    <td>${device.pcModel || 'N/A'}</td>
                    <td>${device.department || 'N/A'}</td>
                    <td>${device.failureReport?.reason?.substring(0, 50) || 'No reason provided'}...</td>
                    <td>${device.failureReport?.reportedBy || 'Unknown'}</td>
                    <td>${priorityBadge}</td>
                    <td>${device.failureReport?.date || 'Unknown'}</td>
                    <td>
                        <button class="btn btn-success btn-sm mark-fixed-btn" data-id="${device.id}" title="Mark as Fixed">
                            <i class="fas fa-wrench"></i> Fix
                        </button>
                        <button class="btn btn-info btn-sm view-failure-btn" data-id="${device.id}" title="View Failure Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                failedDevicesTableBody.appendChild(row);
            });
            
            document.querySelectorAll('.mark-fixed-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const deviceId = this.getAttribute('data-id');
                    showMarkFixedModal(deviceId);
                });
            });
            
            document.querySelectorAll('.view-failure-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const deviceId = this.getAttribute('data-id');
                    showDeviceDetails(deviceId);
                });
            });
        }

        function updateStats() {
            const total = inventoryData.length;
            const active = inventoryData.filter(d => d.status === 'active').length;
            const failed = inventoryData.filter(d => d.status === 'failed').length;
            const replaced = inventoryData.filter(d => d.status === 'replaced').length;
            
            totalDevicesElement.textContent = total;
            activeDevicesElement.textContent = active;
            failedDevicesElement.textContent = failed;
            replacedDevicesElement.textContent = replaced;
        }

        function updateFailureDeviceDropdown() {
            failureDevice.innerHTML = '<option value="">Select a device to report failure</option>';
            inventoryData.forEach(device => {
                if (device.status !== 'failed' && device.status !== 'replaced') {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = `${device.pcNumber} - ${device.pcModel} (${device.userName || 'No User'})`;
                    failureDevice.appendChild(option);
                }
            });
        }

        function updateReplaceDeviceDropdown() {
            replaceDeviceSelect.innerHTML = '<option value="">Select a device to replace</option>';
            inventoryData.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.pcNumber} - ${device.pcModel} (${device.userName || 'No User'})`;
                replaceDeviceSelect.appendChild(option);
            });
        }

        // ============================================
        // ACTION BUTTONS
        // ============================================
        function attachActionButtonListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const deviceId = this.getAttribute('data-id');
                    showDeviceDetails(deviceId);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const deviceId = this.getAttribute('data-id');
                    editDevice(deviceId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const deviceId = this.getAttribute('data-id');
                    showDeleteConfirmation(deviceId);
                });
            });
        }

        // ============================================
        // DEVICE DETAILS (FULL SCREEN)
        // ============================================
        async function showDeviceDetails(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDeviceId = deviceId;
            
            const specsGrid = `
                <div class="specs-grid-modal">
                    ${device.cpu ? `
                    <div class="spec-item">
                        <div class="spec-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <div class="spec-name">CPU</div>
                        <div class="spec-value">${device.cpu}</div>
                    </div>
                    ` : ''}
                    
                    ${device.gpu ? `
                    <div class="spec-item">
                        <div class="spec-icon">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div class="spec-name">GPU</div>
                        <div class="spec-value">${device.gpu}</div>
                    </div>
                    ` : ''}
                    
                    ${device.ram ? `
                    <div class="spec-item">
                        <div class="spec-icon">
                            <i class="fas fa-memory"></i>
                        </div>
                        <div class="spec-name">RAM</div>
                        <div class="spec-value">${device.ram}</div>
                    </div>
                    ` : ''}
                    
                    ${device.storage ? `
                    <div class="spec-item">
                        <div class="spec-icon">
                            <i class="fas fa-hdd"></i>
                        </div>
                        <div class="spec-name">Storage</div>
                        <div class="spec-value">${device.storage}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            let networkInterfacesHTML = '';
            if (device.networkInterfaces && device.networkInterfaces.length > 0) {
                networkInterfacesHTML = `
                    <div class="network-interfaces-grid">
                        ${device.networkInterfaces.map(iface => `
                            <div class="network-interface-card">
                                <h4><i class="fas fa-network-wired"></i> ${iface.interfaceName || 'Network Interface'}</h4>
                                <div class="interface-detail">
                                    <span class="interface-label">IP Address:</span>
                                    <span class="interface-value">${iface.ipAddress || 'N/A'}</span>
                                </div>
                                ${iface.subnetMask ? `
                                <div class="interface-detail">
                                    <span class="interface-label">Subnet Mask:</span>
                                    <span class="interface-value">${iface.subnetMask}</span>
                                </div>
                                ` : ''}
                                ${iface.gateway ? `
                                <div class="interface-detail">
                                    <span class="interface-label">Gateway:</span>
                                    <span class="interface-value">${iface.gateway}</span>
                                </div>
                                ` : ''}
                                ${iface.macAddress ? `
                                <div class="interface-detail">
                                    <span class="interface-label">MAC Address:</span>
                                    <span class="interface-value">${iface.macAddress}</span>
                                </div>
                                ` : ''}
                                ${iface.type ? `
                                <div class="interface-detail">
                                    <span class="interface-label">Type:</span>
                                    <span class="interface-value">${iface.type.charAt(0).toUpperCase() + iface.type.slice(1)}</span>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            let softwareLicensesHTML = '';
            if (device.softwareLicenses && device.softwareLicenses.length > 0) {
                softwareLicensesHTML = `
                    <div class="software-grid">
                        ${device.softwareLicenses.map(software => `
                            <div class="software-card">
                                <h4><i class="fas fa-copyright"></i> ${software.name || 'Unnamed Software'}</h4>
                                ${software.version ? `
                                <div class="software-detail">
                                    <span class="software-label">Version:</span>
                                    <span class="software-value">${software.version}</span>
                                </div>
                                ` : ''}
                                ${software.licenseKey ? `
                                <div class="software-detail">
                                    <span class="software-label">License Key:</span>
                                    <span class="software-value">${software.licenseKey}</span>
                                </div>
                                ` : ''}
                                ${software.licensedTo ? `
                                <div class="software-detail">
                                    <span class="software-label">Licensed To:</span>
                                    <span class="software-value">${software.licensedTo}</span>
                                </div>
                                ` : ''}
                                ${software.expiryDate ? `
                                <div class="software-detail">
                                    <span class="software-label">Expiry Date:</span>
                                    <span class="software-value">${software.expiryDate}</span>
                                </div>
                                ` : ''}
                                ${software.notes ? `
                                <div class="software-detail">
                                    <span class="software-label">Notes:</span>
                                    <span class="software-value">${software.notes}</span>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('deviceDetailsContent').innerHTML = `
                <div class="device-grid">
                    <div class="device-section">
                        <h3><i class="fas fa-desktop"></i> Device Information</h3>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-hashtag"></i> PC Number:</div>
                            <div class="device-value">${device.pcNumber || 'N/A'}</div>
                        </div>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-laptop"></i> PC Model:</div>
                            <div class="device-value">${device.pcModel || 'N/A'}</div>
                        </div>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-barcode"></i> PC Serial:</div>
                            <div class="device-value">${device.pcSerial || 'N/A'}</div>
                        </div>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-building"></i> Department:</div>
                            <div class="device-value">${device.department || 'N/A'}</div>
                        </div>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-user"></i> User Name:</div>
                            <div class="device-value">${device.userName || 'N/A'}</div>
                        </div>
                        <div class="device-item">
                            <div class="device-label"><i class="fas fa-info-circle"></i> Status:</div>
                            <div class="device-value">
                                ${device.status === 'active' ? '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>' : ''}
                                ${device.status === 'failed' ? '<span class="status-badge status-failed"><i class="fas fa-exclamation-triangle"></i> Failed</span>' : ''}
                                ${device.status === 'replaced' ? '<span class="status-badge status-replaced"><i class="fas fa-exchange-alt"></i> Replaced</span>' : ''}
                                ${device.status === 'fixed' ? '<span class="status-badge status-fixed"><i class="fas fa-wrench"></i> Fixed</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="device-section">
                        <h3><i class="fas fa-network-wired"></i> Network Information</h3>
                        ${networkInterfacesHTML || '<p>No network interfaces configured</p>'}
                    </div>
                    
                    <div class="device-section">
                        <h3><i class="fas fa-copyright"></i> Licensed Software</h3>
                        ${softwareLicensesHTML || '<p>No software licenses configured</p>'}
                    </div>
                </div>
                
                <div class="device-section">
                    <h3><i class="fas fa-tv"></i> Monitor Information</h3>
                    <div class="device-item">
                        <div class="device-label"><i class="fas fa-tv"></i> Monitor Model:</div>
                        <div class="device-value">${device.monitorModel || 'N/A'}</div>
                    </div>
                    <div class="device-item">
                        <div class="device-label"><i class="fas fa-hashtag"></i> Monitor Serial:</div>
                        <div class="device-value">${device.monitorSerial || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="device-section">
                    <h3><i class="fas fa-microchip"></i> Specifications</h3>
                    ${specsGrid}
                </div>
                
                ${device.replacedBy ? `
                <div class="device-section" style="border-left: 5px solid var(--warning-color);">
                    <h3><i class="fas fa-exchange-alt"></i> Replacement Information</h3>
                    <div class="device-item">
                        <div class="device-label"><i class="fas fa-user-check"></i> Replaced By:</div>
                        <div class="device-value">${device.replacedBy || 'N/A'}</div>
                    </div>
                    <div class="device-item">
                        <div class="device-label"><i class="fas fa-comment-medical"></i> Reason:</div>
                        <div class="device-value">${device.replacementReason || 'N/A'}</div>
                    </div>
                    <div class="device-item">
                        <div class="device-label"><i class="fas fa-calendar-alt"></i> Replacement Date:</div>
                        <div class="device-value">${device.replacementDate || 'N/A'}</div>
                    </div>
                </div>
                ` : ''}
                
                <div class="device-actions">
                    <button class="btn btn-warning" onclick="editDevice('${deviceId}')">
                        <i class="fas fa-edit"></i> Edit This Device
                    </button>
                    <button class="btn btn-info" onclick="showRepairHistory('${deviceId}')">
                        <i class="fas fa-history"></i> View Repair History & Failure Reports
                    </button>
                    ${device.status === 'failed' ? `
                    <button class="btn btn-success" onclick="showMarkFixedModal('${deviceId}')">
                        <i class="fas fa-wrench"></i> Mark as Fixed
                    </button>
                    ` : ''}
                    <button class="btn btn-danger" onclick="showDeleteConfirmation('${deviceId}')">
                        <i class="fas fa-trash-alt"></i> Delete Device
                    </button>
                </div>
            `;
            
            deviceDetailsModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // ============================================
        // REPAIR HISTORY & FAILURE REPORTS MODAL
        // ============================================
        async function showRepairHistory(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            const repairHistory = await loadRepairHistory(deviceId);
            
            let historyContent = '';
            
            if (device.failureReport) {
                historyContent += `
                    <div class="failure-report-item">
                        <div class="repair-history-header">
                            <div class="repair-history-date">
                                <i class="fas fa-exclamation-triangle"></i> ${device.failureReport.date || 'Unknown Date'}
                            </div>
                            <div class="repair-history-technician">
                                <i class="fas fa-user-check"></i> ${device.failureReport.reportedBy || 'Unknown'}
                            </div>
                        </div>
                        <div class="repair-history-notes">
                            <strong>Failure Report:</strong> ${device.failureReport.reason || 'No reason provided'}
                        </div>
                        <div class="repair-history-notes" style="margin-top: 5px;">
                            <strong>Priority:</strong> ${device.failureReport.priority ? device.failureReport.priority.charAt(0).toUpperCase() + device.failureReport.priority.slice(1) : 'Medium'}
                        </div>
                    </div>
                `;
            }
            
            if (repairHistory.length > 0) {
                historyContent += repairHistory.map(repair => `
                    <div class="repair-history-item">
                        <div class="repair-history-header">
                            <div class="repair-history-date">
                                <i class="fas fa-calendar-alt"></i> ${repair.date}
                            </div>
                            <div class="repair-history-technician">
                                <i class="fas fa-user-check"></i> ${repair.repairedBy}
                            </div>
                        </div>
                        <div class="repair-history-notes">
                            <strong>Repair Notes:</strong> ${repair.notes || 'No notes provided'}
                        </div>
                    </div>
                `).join('');
            }
            
            if (!device.failureReport && repairHistory.length === 0) {
                historyContent = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h4>No History Found</h4>
                        <p>This device has no recorded repair history or failure reports</p>
                    </div>
                `;
            }
            
            document.getElementById('repairHistoryModalContent').innerHTML = `
                <div style="padding: 20px;">
                    <div style="background: var(--secondary-light); padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid var(--primary-color);">
                        <p><strong>Device:</strong> ${device.pcNumber} - ${device.pcModel}</p>
                        <p><strong>Department:</strong> ${device.department}</p>
                        <p><strong>Status:</strong> ${device.status}</p>
                        <p><strong>Total Records:</strong> ${(device.failureReport ? 1 : 0) + repairHistory.length}</p>
                    </div>
                    
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-tools"></i> Repair History & Failure Reports
                    </h4>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${historyContent}
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 25px;">
                        <button class="btn btn-primary" id="closeRepairHistoryBtn">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            repairHistoryModal.style.display = 'flex';
            
            document.getElementById('closeRepairHistoryBtn').addEventListener('click', function() {
                repairHistoryModal.style.display = 'none';
            });
        }

        // ============================================
        // ESC KEY SUPPORT FOR MODALS
        // ============================================
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.key === 'Esc') {
                if (deviceDetailsModal.style.display === 'flex') {
                    deviceDetailsModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
                if (deleteModal.style.display === 'flex') {
                    deleteModal.style.display = 'none';
                }
                if (markFixedModal.style.display === 'flex') {
                    markFixedModal.style.display = 'none';
                }
                if (repairHistoryModal.style.display === 'flex') {
                    repairHistoryModal.style.display = 'none';
                }
            }
        });

        // ============================================
        // MARK AS FIXED MODAL
        // ============================================
        function showMarkFixedModal(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDeviceId = deviceId;
            
            document.getElementById('markFixedModalContent').innerHTML = `
                <div style="padding: 20px;">
                    <p>Mark device as fixed:</p>
                    <div style="background: var(--secondary-light); padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid var(--primary-color);">
                        <p><strong>PC Number:</strong> ${device.pcNumber}</p>
                        <p><strong>PC Model:</strong> ${device.pcModel}</p>
                        <p><strong>Department:</strong> ${device.department}</p>
                        <p><strong>Failure Reason:</strong> ${device.failureReport?.reason?.substring(0, 100) || 'No reason provided'}...</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="fixedBy"><i class="fas fa-user-check"></i> Fixed By *</label>
                        <select id="fixedBy" required>
                            <option value="">Select Technician</option>
                            ${currentSite.technicians.map(tech => `<option value="${tech}">${tech}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="fixNotes"><i class="fas fa-comment-medical"></i> Fix Notes *</label>
                        <textarea id="fixNotes" rows="3" placeholder="Describe what was fixed..." required></textarea>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 25px;">
                        <button class="btn btn-success" id="confirmMarkFixedBtn">
                            <i class="fas fa-wrench"></i> Mark as Fixed
                        </button>
                        <button class="btn btn-warning" id="cancelMarkFixedBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            markFixedModal.style.display = 'flex';
            
            document.getElementById('confirmMarkFixedBtn').addEventListener('click', async function() {
                await markDeviceAsFixed(currentDeviceId);
                markFixedModal.style.display = 'none';
                deviceDetailsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
            
            document.getElementById('cancelMarkFixedBtn').addEventListener('click', function() {
                markFixedModal.style.display = 'none';
            });
        }

        async function markDeviceAsFixed(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            const fixedBy = document.getElementById('fixedBy').value;
            const fixNotes = document.getElementById('fixNotes').value;
            
            if (!fixedBy || !fixNotes) {
                alert('Please fill in all required fields');
                return;
            }
            
            const repairData = {
                date: formatDateTime(getSriLankaTime()),
                repairedBy: fixedBy,
                notes: fixNotes,
                status: 'fixed'
            };
            
            try {
                await addRepairHistoryEntry(deviceId, repairData);
                
                const success = await updateDeviceInFirebase(deviceId, { 
                    status: 'active',
                    fixedBy: fixedBy,
                    fixNotes: fixNotes,
                    fixedDate: new Date().toISOString().split('T')[0],
                    lastRepairDate: repairData.date,
                    lastRepairBy: fixedBy,
                    lastRepairNotes: fixNotes
                });
                
                if (success) {
                    await addLogEntry('Device Fixed', 
                        `${device.pcNumber} marked as fixed by ${fixedBy}. Notes: ${fixNotes}`);
                }
            } catch (error) {
                console.error("Error marking device as fixed:", error);
            }
        }

        // ============================================
        // EDIT DEVICE
        // ============================================
        function editDevice(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDeviceId = deviceId;
            isEditMode = true;
            
            document.getElementById('pcNumber').value = device.pcNumber || '';
            document.getElementById('pcModel').value = device.pcModel || '';
            document.getElementById('department').value = device.department || '';
            document.getElementById('userName').value = device.userName || '';
            document.getElementById('pcSerial').value = device.pcSerial || '';
            document.getElementById('cpu').value = device.cpu || '';
            document.getElementById('gpu').value = device.gpu || '';
            document.getElementById('ram').value = device.ram || '';
            document.getElementById('storage').value = device.storage || '';
            document.getElementById('monitorModel').value = device.monitorModel || '';
            document.getElementById('monitorSerial').value = device.monitorSerial || '';
            document.getElementById('status').value = device.status || 'active';
            
            networkInterfacesList.innerHTML = '';
            if (device.networkInterfaces && device.networkInterfaces.length > 0) {
                device.networkInterfaces.forEach((iface, index) => {
                    const interfaceElement = createNetworkInterfaceElement(iface, index);
                    networkInterfacesList.appendChild(interfaceElement);
                });
            } else {
                const defaultInterface = createNetworkInterfaceElement({
                    id: 'default-interface',
                    interfaceName: 'Primary Interface',
                    ipAddress: device.ipAddress || '',
                    subnetMask: device.subnetMask || '255.255.255.0',
                    gateway: device.gateway || '',
                    type: 'ethernet'
                }, 0);
                networkInterfacesList.appendChild(defaultInterface);
            }
            
            softwareLicensesList.innerHTML = '';
            if (device.softwareLicenses && device.softwareLicenses.length > 0) {
                device.softwareLicenses.forEach((software, index) => {
                    const softwareElement = createSoftwareLicenseElement(software, index);
                    softwareLicensesList.appendChild(softwareElement);
                });
            } else {
                const defaultSoftware = createSoftwareLicenseElement({
                    id: 'default-software',
                    name: 'Operating System'
                }, 0);
                softwareLicensesList.appendChild(defaultSoftware);
            }
            
            sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector('[data-section="addDevice"]').classList.add('active');
            
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'addDevice') {
                    section.classList.add('active');
                    document.querySelector('#addDevice h2').innerHTML = '<i class="fas fa-edit"></i> Edit Device';
                    document.getElementById('pcNumber').focus();
                }
            });
            
            deviceDetailsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ============================================
        // DELETE DEVICE
        // ============================================
        function showDeleteConfirmation(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            currentDeviceId = deviceId;
            
            document.getElementById('deleteModalContent').innerHTML = `
                <div style="padding: 20px;">
                    <p>Are you sure you want to delete this device?</p>
                    <div style="background: var(--secondary-light); padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid var(--danger-color);">
                        <p><strong>PC Number:</strong> ${device.pcNumber}</p>
                        <p><strong>PC Model:</strong> ${device.pcModel}</p>
                        <p><strong>Department:</strong> ${device.department}</p>
                        <p><strong>User:</strong> ${device.userName || 'N/A'}</p>
                    </div>
                    <p style="color: var(--danger-color); font-weight: 600; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> This action cannot be undone!
                    </p>
                    <div class="action-buttons" style="margin-top: 25px;">
                        <button class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="fas fa-trash-alt"></i> Delete Device
                        </button>
                        <button class="btn btn-warning" id="cancelDeleteBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            deleteModal.style.display = 'flex';
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                await deleteDevice(currentDeviceId);
                deleteModal.style.display = 'none';
                deviceDetailsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
            
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        }

        async function deleteDevice(deviceId) {
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) return;
            
            try {
                const success = await deleteDeviceFromFirebase(deviceId);
                
                if (success) {
                    await addLogEntry('Device Deleted', 
                        `Deleted ${device.pcNumber} (${device.pcModel}) from ${device.department}`);
                }
            } catch (error) {
                console.error("Error deleting device:", error);
            }
        }

        // ============================================
        // FORM SUBMISSIONS
        // ============================================
        deviceForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            saveDeviceBtn.disabled = true;
            saveDeviceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const networkInterfaces = collectNetworkInterfacesData();
            const softwareLicenses = collectSoftwareLicensesData();
            
            const deviceData = {
                pcNumber: document.getElementById('pcNumber').value.trim(),
                pcModel: document.getElementById('pcModel').value.trim(),
                department: document.getElementById('department').value,
                userName: document.getElementById('userName').value.trim(),
                pcSerial: document.getElementById('pcSerial').value.trim(),
                cpu: document.getElementById('cpu').value.trim(),
                gpu: document.getElementById('gpu').value.trim(),
                ram: document.getElementById('ram').value.trim(),
                storage: document.getElementById('storage').value.trim(),
                monitorModel: document.getElementById('monitorModel').value.trim(),
                monitorSerial: document.getElementById('monitorSerial').value.trim(),
                status: document.getElementById('status').value,
                networkInterfaces: networkInterfaces,
                softwareLicenses: softwareLicenses,
                site: currentSite.name
            };
            
            if (networkInterfaces.length > 0) {
                deviceData.ipAddress = networkInterfaces[0].ipAddress || '';
                deviceData.subnetMask = networkInterfaces[0].subnetMask || '';
                deviceData.gateway = networkInterfaces[0].gateway || '';
            }
            
            try {
                if (isEditMode) {
                    const success = await updateDeviceInFirebase(currentDeviceId, deviceData);
                    
                    if (success) {
                        await addLogEntry('Device Edited', 
                            `Updated ${deviceData.pcNumber} (${deviceData.pcModel})`);
                    }
                } else {
                    const newDeviceId = await saveDeviceToFirebase(deviceData);
                    
                    if (newDeviceId) {
                        await addLogEntry('Device Added', 
                            `Added ${deviceData.pcNumber} (${deviceData.pcModel}) to ${deviceData.department}`);
                    }
                }
                
                sidebarItems.forEach(i => i.classList.remove('active'));
                document.querySelector('[data-section="inventory"]').classList.add('active');
                
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === 'inventory') {
                        section.classList.add('active');
                    }
                });
                
                resetForm();
                
            } catch (error) {
                console.error("Error saving device:", error);
            } finally {
                saveDeviceBtn.disabled = false;
                saveDeviceBtn.innerHTML = '<i class="fas fa-save"></i> Save Device';
            }
        });

        failureReportForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            reportFailureBtn.disabled = true;
            reportFailureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reporting...';
            
            const deviceId = failureDevice.value;
            const reason = document.getElementById('failureReason').value.trim();
            const date = document.getElementById('failureDate').value;
            const reportedBy = document.getElementById('reportedBy').value;
            const priority = document.getElementById('failurePriority').value;
            
            if (!deviceId || !reason || !date || !reportedBy) {
                reportFailureBtn.disabled = false;
                reportFailureBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Report Failure';
                return;
            }
            
            const device = inventoryData.find(d => d.id === deviceId);
            if (!device) {
                reportFailureBtn.disabled = false;
                reportFailureBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Report Failure';
                return;
            }
            
            try {
                const success = await updateDeviceInFirebase(deviceId, { 
                    status: 'failed',
                    failureReport: {
                        reason: reason,
                        date: date,
                        reportedBy: reportedBy,
                        priority: priority
                    }
                });
                
                if (success) {
                    await addLogEntry('Device Failure Reported', 
                        `${device.pcNumber} marked as failed. Reason: ${reason} (Priority: ${priority})`);
                    
                    failureReportForm.reset();
                    document.getElementById('failureDate').valueAsDate = new Date();
                    
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    document.querySelector('[data-section="failedDevices"]').classList.add('active');
                    
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === 'failedDevices') {
                            section.classList.add('active');
                        }
                    });
                }
            } catch (error) {
                console.error("Error reporting failure:", error);
            } finally {
                reportFailureBtn.disabled = false;
                reportFailureBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Report Failure';
            }
        });

        replaceDeviceForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            replaceDeviceBtn.disabled = true;
            replaceDeviceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Replacing...';
            
            const oldDeviceId = replaceDeviceSelect.value;
            const newPcNumber = document.getElementById('replacementPcNumber').value.trim();
            const newPcModel = document.getElementById('replacementPcModel').value.trim();
            const newSerial = document.getElementById('replacementSerial').value.trim();
            const replacementDate = document.getElementById('replacementDate').value;
            const reason = document.getElementById('replacementReason').value.trim();
            const replacedBy = document.getElementById('replacedBy').value;
            
            if (!oldDeviceId || !newPcNumber || !newPcModel || !newSerial || !replacementDate || !replacedBy) {
                replaceDeviceBtn.disabled = false;
                replaceDeviceBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Replace Device';
                return;
            }
            
            const oldDevice = inventoryData.find(d => d.id === oldDeviceId);
            if (!oldDevice) {
                replaceDeviceBtn.disabled = false;
                replaceDeviceBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Replace Device';
                return;
            }
            
            try {
                const success1 = await updateDeviceInFirebase(oldDeviceId, { 
                    status: 'replaced',
                    replacedBy: replacedBy,
                    replacementDate: replacementDate,
                    replacementReason: reason
                });
                
                const newDeviceData = {
                    pcNumber: newPcNumber,
                    pcModel: newPcModel,
                    department: oldDevice.department || '',
                    userName: oldDevice.userName || '',
                    pcSerial: newSerial,
                    cpu: oldDevice.cpu || '',
                    gpu: oldDevice.gpu || '',
                    ram: oldDevice.ram || '',
                    storage: oldDevice.storage || '',
                    monitorModel: oldDevice.monitorModel || '',
                    monitorSerial: oldDevice.monitorSerial || '',
                    status: 'active',
                    replacedFrom: oldDeviceId,
                    networkInterfaces: oldDevice.networkInterfaces || [],
                    softwareLicenses: oldDevice.softwareLicenses || [],
                    site: currentSite.name
                };
                
                const newDeviceId = await saveDeviceToFirebase(newDeviceData);
                
                if (success1 && newDeviceId) {
                    await addLogEntry('Device Replaced', 
                        `${oldDevice.pcNumber} replaced with ${newPcNumber}. Reason: ${reason || 'Not specified'}`);
                    
                    replaceDeviceForm.reset();
                    document.getElementById('replacementDate').valueAsDate = new Date();
                    
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    document.querySelector('[data-section="inventory"]').classList.add('active');
                    
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === 'inventory') {
                            section.classList.add('active');
                        }
                    });
                }
            } catch (error) {
                console.error("Error replacing device:", error);
            } finally {
                replaceDeviceBtn.disabled = false;
                replaceDeviceBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Replace Device';
            }
        });

        // ============================================
        // LOGS FUNCTIONS
        // ============================================
        function loadLogs() {
            const searchTerm = logSearchBox.value.toLowerCase();
            const logType = logTypeFilter.value;
            
            let filteredLogs = activityLogs.filter(log => {
                const matchesSearch = 
                    (log.action && log.action.toLowerCase().includes(searchTerm)) || 
                    (log.details && log.details.toLowerCase().includes(searchTerm)) ||
                    (log.user && log.user.toLowerCase().includes(searchTerm));
                
                const matchesType = !logType || log.action === logType;
                
                return matchesSearch && matchesType;
            });
            
            logsContainer.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                logsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h4>No activity logs found</h4>
                        <p>Perform some actions in the system to see logs here</p>
                    </div>
                `;
                return;
            }
            
            filteredLogs.forEach(log => {
                let icon = 'fas fa-info-circle';
                if (log.action.includes('Login')) icon = 'fas fa-sign-in-alt';
                else if (log.action.includes('Added')) icon = 'fas fa-plus-circle';
                else if (log.action.includes('Edited')) icon = 'fas fa-edit';
                else if (log.action.includes('Deleted')) icon = 'fas fa-trash-alt';
                else if (log.action.includes('Failure')) icon = 'fas fa-exclamation-triangle';
                else if (log.action.includes('Fixed')) icon = 'fas fa-wrench';
                else if (log.action.includes('Replaced')) icon = 'fas fa-exchange-alt';
                else if (log.action.includes('Excel Import')) icon = 'fas fa-file-import';
                else if (log.action.includes('Excel Export')) icon = 'fas fa-file-export';
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <div class="log-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="log-content">
                        <div class="log-timestamp">${log.timestamp}</div>
                        <div class="log-action">${log.action} (${log.site})</div>
                        <div class="log-details">${log.details}</div>
                        <div class="log-details" style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                            <i class="fas fa-user"></i> ${log.user}
                        </div>
                    </div>
                `;
                logsContainer.appendChild(logEntry);
            });
        }

        async function addLogEntry(action, details) {
            const timestamp = formatSriLankaTimestamp(getSriLankaTime());
            
            const logEntry = {
                timestamp: timestamp,
                action: action,
                details: details,
                user: currentUser,
                site: currentSite.name
            };
            
            console.log(" Adding log entry:", action, details, "at", timestamp);
            
            await addLogToFirebase(logEntry);
            
            activityLogs.unshift({
                id: 'temp-' + Date.now(),
                timestamp: timestamp,
                action: action,
                details: details,
                user: currentUser,
                site: currentSite.name
            });
            
            if (document.getElementById('logs').classList.contains('active')) {
                loadLogs();
            }
        }

        // ============================================
        // RESET FORM
        // ============================================
        function resetForm() {
            deviceForm.reset();
            isEditMode = false;
            currentDeviceId = null;
            document.querySelector('#addDevice h2').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Device';
            document.getElementById('department').value = '';
            document.getElementById('status').value = 'active';
            addDefaultNetworkInterface();
            addDefaultSoftwareLicense();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        addNewBtn.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector('[data-section="addDevice"]').classList.add('active');
            
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'addDevice') {
                    section.classList.add('active');
                    resetForm();
                    document.getElementById('pcNumber').focus();
                }
            });
        });

        cancelBtn.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector('[data-section="inventory"]').classList.add('active');
            
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'inventory') {
                    section.classList.add('active');
                }
            });
        });

        cancelFailureBtn.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector('[data-section="inventory"]').classList.add('active');
            
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'inventory') {
                    section.classList.add('active');
                }
            });
        });

        cancelReplaceFormBtn.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            document.querySelector('[data-section="inventory"]').classList.add('active');
            
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === 'inventory') {
                    section.classList.add('active');
                }
            });
        });

        searchBox.addEventListener('input', loadInventoryTable);
        departmentFilter.addEventListener('change', loadInventoryTable);
        failedSearchBox.addEventListener('input', loadFailedDevicesTable);
        failedPriorityFilter.addEventListener('change', loadFailedDevicesTable);
        logSearchBox.addEventListener('input', loadLogs);
        logTypeFilter.addEventListener('change', loadLogs);
        
        refreshBtn.addEventListener('click', async function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            await loadInventoryFromFirebase();
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        });

        refreshFailedBtn.addEventListener('click', async function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            await loadInventoryFromFirebase();
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        });

        refreshLogsBtn.addEventListener('click', async function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            if (logsUnsubscribe) {
                logsUnsubscribe();
            }
            startRealTimeLogs();
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        });

        closeDetailsModal.addEventListener('click', function() {
            deviceDetailsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
        closeDeleteModal.addEventListener('click', function() {
            deleteModal.style.display = 'none';
        });
        
        closeMarkFixedModal.addEventListener('click', function() {
            markFixedModal.style.display = 'none';
        });
        
        closeRepairHistoryModal.addEventListener('click', function() {
            repairHistoryModal.style.display = 'none';
        });
        
        window.addEventListener('click', function(e) {
            if (e.target === deviceDetailsModal) {
                deviceDetailsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            if (e.target === deleteModal) deleteModal.style.display = 'none';
            if (e.target === markFixedModal) markFixedModal.style.display = 'none';
            if (e.target === repairHistoryModal) repairHistoryModal.style.display = 'none';
        });

        viewDiagramBtn.addEventListener('click', function() {
            if (currentSite) {
                window.open(currentSite.networkDiagram, '_blank');
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        const today = new Date();
        document.getElementById('failureDate').valueAsDate = today;
        document.getElementById('replacementDate').valueAsDate = today;

        // Enter key for login
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loginBtn.click();
        });

        usernameInput.addEventListener('input', function() {
            this.style.borderColor = "#D1DDDE";
            loginError.style.display = 'none';
        });

        passwordInput.addEventListener('input', function() {
            this.style.borderColor = "#D1DDDE";
            loginError.style.display = 'none';
        });

        window.addEventListener('DOMContentLoaded', async function() {
            console.log(" IT Management Interface Initialized");
            console.log(" Theme: WTC Teal Theme (Both Sites)");
            console.log(" Timezone: Sri Lanka Time (Local Browser Time)");
            console.log(" Firebase Project: inventory-3650f");
            console.log(" Excel Support: Import/Export with SheetJS");
            console.log(" Features: Multi-site, Excel Import/Export, Switch Site");
            console.log(" Activity Logs: Site-specific logging enabled");
            console.log(" Enter Key Navigation: Enabled for forms");
            
            const currentTime = getSriLankaTime();
            console.log(" Current Sri Lanka Time:", formatSriLankaTimestamp(currentTime));
            
            for (let i = 0; i < 5; i++) {
                const animation = document.createElement('div');
                animation.className = 'login-animation';
                animation.style.width = Math.random() * 80 + 40 + 'px';
                animation.style.height = animation.style.width;
                animation.style.top = Math.random() * 100 + '%';
                animation.style.left = Math.random() * 100 + '%';
                animation.style.animationDelay = Math.random() * 10 + 's';
                loginPage.appendChild(animation);
            }
            
            usernameInput.focus();
        });

    </script>
</body>
</html>
